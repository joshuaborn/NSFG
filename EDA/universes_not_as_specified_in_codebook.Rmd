---
title: "Variables Discovered Whose Universes Are Not as Specified in Codebook"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

i_am('EDA/universes_not_as_specified_in_codebook.Rmd')

source(here('R/NSFG_helpers.R'))
source(here('R/general_helpers.R'))

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r load-data}
fem1719 <- load_NSFG_data('2017_2019', 'FemResp')
male1719 <- load_NSFG_data('2017_2019', 'Male')
```

# `CONDVAG`

For both males and females, all the cases that are in the universe for `CONDVAG` as specified in the codebook have answers for `CONDVAG`. However, some cases not in the universe for `CONDVAG` as specified in the codebook also have answers for `CONDVAG`. All of these cases have "Not ascertained" answers for `VAGSEX`.

## Females

```{r, dependson='load-data'}
fem1719$Data[
  is.na(VAGSEX) | VAGSEX == 1,
  table(
    CONDVAG,
    useNA = 'ifany'
  )
] |> kable()
```

```{r, dependson='load-data'}
fem1719$Data[
  !is.na(CONDVAG),
  table(
    VAGSEX,
    useNA = 'ifany'
  )
] |> kable()
```

## Males

```{r, dependson='load-data'}
male1719$Data[
  is.na(VAGSEX) | VAGSEX == 1,
  table(
    CONDVAG,
    useNA = 'ifany'
  )
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(CONDVAG),
  table(
    VAGSEX,
    useNA = 'ifany'
  )
] |> kable()
```


# `MISSPILL`

There cases that are in the universe for `MISSPILL` as specified in the codebook, but do not have answers for `MISSPILL`. However, all of the cases that have answers for `MISSPILL` are in the universe for `MISSPILL` specified in the codebook.

```{r, dependson='load-data'}
fem1719$Data[
  is.na(MISSPILL) &
    (
      equals(CURRMETH1, 3) |
      equals(CURRMETH2, 3) |
      equals(CURRMETH3, 3) |
      equals(CURRMETH4, 3) |
      equals(LSTMONMETH1, 3) |
      equals(LSTMONMETH2, 3) |
      equals(LSTMONMETH3, 3) |
      equals(LSTMONMETH4, 3)
    ),
  .(
    CASEID,
    MISSPILL,
    CURRMETH1,
    CURRMETH2,
    CURRMETH3,
    CURRMETH4,
    LSTMONMETH1,
    LSTMONMETH2,
    LSTMONMETH3,
    LSTMONMETH4
  )
] |> kable()
```

```{r, dependson='load-data'}
fem1719$Data[
  !is.na(MISSPILL),
  table(
    equals(CURRMETH1, 3) |
      equals(CURRMETH2, 3) |
      equals(CURRMETH3, 3) |
      equals(CURRMETH4, 3) |
      equals(LSTMONMETH1, 3) |
      equals(LSTMONMETH2, 3) |
      equals(LSTMONMETH3, 3) |
      equals(LSTMONMETH4, 3),
    useNA = 'ifany'
  )
] |> kable()
```


# `P12MOCON`, `P12MOCONO`, and `PXNOFREQ`

## Females

There cases that are in the universe for `P12MOCON` as specified in the codebook, but do not have answers for `P12MOCON`. Additionally, there are answers for `P12MOCON` for cases not in the universe for `P12MOCON` specified in the codebook.

All the cases that are in the universe for `PXNOFREQ` as specified in the codebook have answers for `PXNOFREQ`. However, some cases not in the universe for `PXNOFREQ` as specified in the codebook also have answers for `PXNOFREQ`.

```{r, dependson='load-data'}
fem1719_MONSX <- create_NSFG_pivot_table(
  'CMMONSX',
  2:48,
  c('CASEID', 'CMINTVW', 'CMLSTYR')
)[
  create_NSFG_pivot_table('MONSX', 2:48),
  on = c(CASEID = 'CASEID', CMMONSXID = 'MONSXID')
]

fem1719_sex12mo <- fem1719_MONSX[
  !is.na(MONSX) & MONSX == 1 &
    CMMONSX > CMLSTYR &
    CMMONSX <= CMINTVW,
  .(sex12mo = .N > 1),
  by = CASEID
]


fem1719_sex12mo[
  fem1719$Data
][
  sex12mo &
    CONDOM == 1 &
    is.na(P12MOCON),
  .(
    CASEID,
    sex12mo,
    CONDOM,
    P12MOCON
  )
] |> kable()


fem1719_sex12mo[
  fem1719$Data
][
  !is.na(P12MOCON) & (!sex12mo | CONDOM != 1),
  .(
    CASEID,
    P12MOCON,
    CASEID,
    sex12mo,
    CONDOM
  )
] |> kable()


fem1719_sex12mo[
  fem1719$Data
][
  sex12mo &
    equals(EVERUSED, 1) &
    P12MOCON != 1,
  table(PXNOFREQ, useNA = 'ifany')
] |> kable()


fem1719_sex12mo[
  fem1719$Data
][
  !is.na(PXNOFREQ) & !(
    sex12mo &
    equals(EVERUSED, 1) &
    P12MOCON != 1
  ),
  .(
    CASEID,
    PXNOFREQ,
    sex12mo,
    EVERUSED,
    P12MOCON
  )
] |> kable()
```

## Males

All the cases that are in the universe for `P12MOCON` as specified in the codebook have answers for `P12MOCON`, and all of the cases with answers to `P12MOCON` are in the universe for `P12MOCON` specified in the codebook.

Similarly, all the cases that are in the universe for `P12MOCONO` as specified in the codebook have answers for `P12MOCONO`, and all of the cases with answers to `P12MOCONO` are in the universe for `P12MOCONO` specified in the codebook.

One of the cases in the universe for `PXNOFREQ` as specified in the codebook does not have an answer for `PXNOFREQ`. However, all of the cases with answers to `PXNOFREQ` are in the universe for `PXNOFREQ` specified in the codebook.

```{r, dependson='load-data'}
male1719$Data[
  equals(SEXSTAT, 1),
  table(P12MOCONO, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  SEXSTAT %in% c(2, 6),
  table(P12MOCON, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(P12MOCONO),
  table(SEXSTAT, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(P12MOCON),
  table(SEXSTAT, useNA = 'ifany')
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  equals(PXANYUSE, 1) & PXCONFRQ != 100 & is.na(PXNOFREQ),
  .(
    CASEID,
    PXANYUSE,
    PXCONFRQ,
    PXNOFREQ
  )
] |> kable()
```

```{r, dependson='load-data'}
male1719$Data[
  !is.na(PXNOFREQ) & !(
    equals(PXANYUSE, 1) & PXCONFRQ != 100
  ),
 .N
] |> kable()
```


# `TYPEIUD_1`

All the cases that are in the universe for `TYPEIUD_1` as specified in the codebook have answers for `TYPEIUD_1`. However, two cases not in the universe for `TYPEIUD_1` as specified in the codebook also have answers for `TYPEIUD_1`.

```{r, dependson='load-data'}
fem1719$Data[
  equals(METHSTOP01, 19) |
  equals(METHSTOP02, 19) |
  equals(METHSTOP03, 19) |
  equals(METHSTOP04, 19) |
  equals(METHSTOP05, 19) |
  equals(METHSTOP06, 19) |
  equals(METHSTOP07, 19) |
  equals(METHSTOP08, 19) |
  equals(METHSTOP09, 19) |
  equals(METHSTOP10, 19),
  table(
    TYPEIUD_1,
    useNA = 'ifany'
  )
] |> kable()
```

```{r, dependson='load-data'}
fem1719$Data[
  !is.na(TYPEIUD_1) & !(
    equals(METHSTOP01, 19) |
    equals(METHSTOP02, 19) |
    equals(METHSTOP03, 19) |
    equals(METHSTOP04, 19) |
    equals(METHSTOP05, 19) |
    equals(METHSTOP06, 19) |
    equals(METHSTOP07, 19) |
    equals(METHSTOP08, 19) |
    equals(METHSTOP09, 19) |
    equals(METHSTOP10, 19)
  ),
  .(
    CASEID,
    TYPEIUD_1,
    METHSTOP01,
    METHSTOP02,
    METHSTOP03,
    METHSTOP04,
    METHSTOP05,
    METHSTOP06,
    METHSTOP07,
    METHSTOP08,
    METHSTOP09,
    METHSTOP10
  )
] |> kable()
```


* `WHYNOTUSE`
* `YNOSEX` vs `HADSEX`
* `YUSEIUD1`
