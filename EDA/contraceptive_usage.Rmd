---
title: "Contraceptive Usage"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(here)
library(knitr)
library(survey)

i_am('EDA/contraceptive_usage.Rmd')

source(here('R/survey_helpers.R'))
source(here('R/import.R'))

opts_chunk$set(
  echo = TRUE,
  cache = FALSE
)
```


## Female Persons Aged 15-49

```{r, load-data}
fem_2017_2019 <- load_NSFG_data('2017_2019', 'FemResp')
fem_data <- fem_2017_2019$Data
fem_formats <- fem_2017_2019$Formats
```

```{r, setup-data}
fem_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = fem_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```


### Currently Using

```{r}
kable(fem_formats[format_name == 'CONSTATF'])
```

It seems like the NSFG recodes count a respondent as currently using contraception if has had sexual intercourse in the past 3 months with someone of the opposite sex and used a contraceptive during the last intercourse.

```{r}
tablena(fem_data$HADSEX)
tablena(fem_data$SEX3MO)
tablena(fem_data$SEXP3MO)
tablena(fem_data$MTHUSE3)
fem_data[, sum(is.na(HADSEX), is.na(MTHUSE3))]
```

Togther the above variables form a set. Those who have `2` for `HADSEX` are `NA` for `SEX3MO`, and those who have either a `2` for `HADSEX` or `2` for `SEX3MO` are `NA` for `MTHUSE3`.

There is another variable `SEXP30MO` which comes from the months of non-intercourse series that reports a higher count of those who have had sex in the past 3 months than `SEX3MO`.

```{r}
fem_data[, women := 1]

ksvytotalci(~women, fem_svy)
```

According to the U.S. Census Bureau, Current Population Survey, Annual Social and Economic Supplement, 2019, Table 1. Population by Age and Sex: 2019. The female civilian noninstitutionalized population of the United States is ~74,445,000. The estimate generated from the NSFG is consistent with this.

```{r}
kable(fem_formats[startsWith(format_name, 'MTHUSE3F')])

fem_data[, MTHUSE3_factor := factorize(MTHUSE3, 'MTHUSE3F', fem_formats)]

ksvybyci(~women, ~MTHUSE3_factor, fem_svy, svytotal)

ksvyci(~MTHUSE3_factor, fem_svy, svymean)
```

```{r, females-currently-totals, fig.height=8, fig.width=6}
fem_data[, currently := factor(
  fifelse(
    !is.na(MTHUSE3) & MTHUSE3 == 1,
    'Currently using contraception',
    'Not currently using contraception'
  )
)]

female_currently_totals <- svybyci(~women, ~currently, fem_svy, svytotal)

female_currently_totals[, 2:5] <- female_currently_totals[, 2:5] / 10^6

ggplot(
  data = female_currently_totals,
  mapping = aes(
    x = currently
  )
) +
  geom_point(
    aes(
      y = women
    ),
    size = 4
  ) +
  geom_segment(
    aes(
      xend = currently,
      y = `2.5 %`,
      yend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.125, 'inches')),
    size = 1
  ) +
  scale_y_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1),
    minor_breaks = \(limits) seq(floor(limits[1]), limits[2], 1)
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Number of persons currently using contraception',
    y = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_blank()
  )
```

```{r, females-currently-proportions, fig.width=8, fig.height=2.5}
female_currently_proportions <- svyci(~currently, fem_svy, svymean)

ggplot(
  data = female_currently_proportions[1],
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = total
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = NULL
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Proportion of persons currently using contraception'
  ) +
  theme_bw() +
  theme(
    axis.ticks.y = element_blank(),
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

```{r}
fem_data[, tablena(METH3M1)]
fem_data[, tablena(LSTMTHP1)]
fem_data[, tablena(METH3M2)]
fem_data[, tablena(LSTMTHP2)]
fem_data[, tablena(METH3M3)]
fem_data[, tablena(LSTMTHP3)]
fem_data[, tablena(METH3M4)]
fem_data[, tablena(LSTMTHP4)]
fem_data[, tablena(LSTMTHP5)]
```

It appears that no women reported using more than 3 methods of contraception at last intercourse with last partner. (`LSTMTHP5` refers to 2nd-to-last partner.)

```{r}
kable(fem_formats[format_name == 'METH3MF'])
```

```{r}
fem_data[, `:=`(
  METH3M1_factor = factorize(METH3M1, 'METH3MF', fem_formats),
  METH3M2_factor = factorize(METH3M2, 'METH3MF', fem_formats),
  METH3M3_factor = factorize(METH3M3, 'METH3MF', fem_formats)
)]

current_female_counts <-  as.data.table(fem_data[, tablena(METH3M1_factor)])[
  as.data.table(fem_data[, tablena(METH3M2_factor)]),
  on = 'x'
][
  as.data.table(fem_data[, tablena(METH3M3_factor)]),
  on = 'x'
]

colnames(current_female_counts) <- c('Method', paste('METH3M', 1:3, sep = ''))

kable(current_female_counts)

dim(current_female_counts)
```

"Respondent sterile (aside from sterilizing operation above)" and "Respondentâ€™s partner sterile (aside from vasectomy above)" should be removed from estimates of those using contraception, if this is the only contraceptive method reported.

Additionally, a count of currently used contraceptive methods is useful.

Both of these can be settled with a single new variable.

```{r}
fem_data[, current_contraceptive_count := fcase(
  !is.na(METH3M3) & METH3M3 != 20 & METH3M3 != 21, 3,
  !is.na(METH3M2) & METH3M2 != 20 & METH3M2 != 21, 2,
  !is.na(METH3M1) & METH3M1 != 20 & METH3M1 != 21, 1,
  default = 0
)]

fem_data[, tablena(current_contraceptive_count)]
```

```{r, females-currently-totals-2, fig.height=8, fig.width=6}
fem_data[, currently2 := factor(
  fifelse(
    current_contraceptive_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  )
)]

female_currently_totals2 <- svybyci(~women, ~currently2, fem_svy, svytotal)

female_currently_totals2[, 2:5] <- female_currently_totals2[, 2:5] / 10^6

female_currently_totals2

female_currently_totals

ggplot(
  data = female_currently_totals2,
  mapping = aes(
    x = currently2
  )
) +
  geom_point(
    aes(
      y = women
    ),
    size = 4
  ) +
  geom_segment(
    aes(
      xend = currently2,
      y = `2.5 %`,
      yend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.125, 'inches')),
    size = 1
  ) +
  scale_y_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1),
    minor_breaks = \(limits) seq(floor(limits[1]), limits[2], 1)
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Number of persons currently using contraception',
    y = 'Number of female persons'
  ) +
  theme_bw() +
  theme(
    axis.title.x = element_blank()
  )
```

```{r, females-currently-proportions-2, fig.width=8, fig.height=2.5}
female_currently_proportions2 <- svyci(~currently2, fem_svy, svymean)

female_currently_proportions2

female_currently_proportions

ggplot(
  data = female_currently_proportions2[1],
  aes(
    y = level
  )
) +
  geom_point(
    aes(
      x = total
    ),
    size = 2.5
  ) +
  geom_segment(
    aes(
      yend = level,
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.0625, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = NULL
  ) +
  labs(
    subtitle = 'among females aged 15-49 living in households in the United States',
    title = 'Proportion of persons currently using contraception'
  ) +
  theme_bw() +
  theme(
    axis.ticks.y = element_blank(),
    axis.title = element_blank(),
    legend.position = 'none'
  )
```

As expected, removing those who are infertile not due to a sterilizing operation changes the estimates of current contraceptive users, but only slightly.


## To Do

### Frames for analysis

#### By Table

* Female persons
* Male persons

#### By Columns

* "Current" -- at last intercourse with male in past 3 months
* "Recent" -- over previous year
* "Ever" -- over lifetime

### Questions for Users

* Which contraceptives?
* How many?
* For reasons other than contraception?
* For "recent," how consistent?
* For "recent" and for multiple methods users, simultaneously or alternatively?

### Questions for Nonusers

* Not sexually active?
    * Ever or just now?
* Currently pregnant?
* Trying to get pregnant?
* (Naturally) infertile?
* Exclusively same-sex partner(s)?
* For those fertile, heterosexually active, not using contraception, and not desiring pregnancy, why no contraception usage?

### Covariates/Subdomains

* Want children in future, but not just not now
* By sex education
* By income
* By religion
    * Roman Catholics are a subdomain of interest.
* Second phase vs. first-phase (to investigate nonresponse bias)

### Other

* Try combining with 2015-2017 data for more precise estimates?


## Male Persons Aged 15-49

```{r, load-male-data}
male_2017_2019 <- load_NSFG_data('2017_2019', 'Male')

male_data <- male_2017_2019$Data
```

```{r, setup-male-data}
male_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = male_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```

According to the U.S. Census Bureau, ibid. The number of civilian noninstitutionalized male persons in the United States is ~74,238,000.
