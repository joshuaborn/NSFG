---
title: "Males Who Do Not Know Whether Partner Used Contraception"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

i_am('EDA/010_males_who_do_not_know.Rmd')

source(here('R/factor_helpers.R'))
source(here('R/import.R'))

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```


```{r male-load-data, depeondson='setup'}
male_2017_2019 <- load_NSFG_data('2017_2019', 'Male')
male_2017_2019_formats <- male_2017_2019$Formats
```

```{r male-process-data, dependson=c('male-load-data')}
male_2017_2019_data <- copy(male_2017_2019$Data[, .(
  CWPPOSS = factorize(CWPPOSS, 'Y1N5RDF', male_2017_2019_formats),
  CWPPRGNW = factorize(CWPPRGNW, 'Y1N5RDF', male_2017_2019_formats),
  CWPTRYPG = factorize(CWPTRYPG, 'Y1N5RDF', male_2017_2019_formats),
  FATHPOSS = factorize(FATHPOSS, 'Y1N5RDF', male_2017_2019_formats),
  METH3M1 = factorize(METH3M1, 'METH3MF', male_2017_2019_formats),
  METH3M2 = factorize(METH3M2, 'METH3MF', male_2017_2019_formats),
  METH3M3 = factorize(METH3M3, 'METH3MF', male_2017_2019_formats),
  METH3M4 = factorize(METH3M4, 'METH3MF', male_2017_2019_formats),
  P1COHABIT = factorize(P1COHABIT, 'Y1N5RDF', male_2017_2019_formats),
  P1CURRWIFE = factorize(P1CURRWIFE, 'Y1N5RDF', male_2017_2019_formats),
  PSURGSTR = factorize(PSURGSTR, 'N0Y1CF', male_2017_2019_formats),
  PXCPREG = factorize(PXCPREG, 'Y1N5RDF', male_2017_2019_formats),
  PXTRYING = factorize(PXTRYING, 'Y1N5RDF', male_2017_2019_formats),
  RSURGSTR  = factorize(RSURGSTR, 'N0Y1RDF', male_2017_2019_formats),
  SECU,
  SEST,
  SEX3MO = factorize(SEX3MO, 'SEX3MO', male_2017_2019_formats),
  WGT2017_2019
)])

# create boolean variables for whether each specific method is currently used
for (x in 1:13) {
  set(
    male_2017_2019_data,
    j = sprintf('using3m_meth%d', x),
    value = has_level(male_2017_2019_data$METH3M1, x) |
      has_level(male_2017_2019_data$METH3M2, x) |
      has_level(male_2017_2019_data$METH3M3, x) |
      has_level(male_2017_2019_data$METH3M4, x)
  )
}

# count any respondents who are sexually active and who have an active vasectomy as using vasectomy as a contraceptive method
male_2017_2019_data[, using3m_meth3 := fifelse(
  SEX3MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
  TRUE,
  using3m_meth3
)]

# count any respondents who are sexually active and who are married or cohabitating and whose last intercourse was with wife or cohabitating partner who has active tubal ligation
male_2017_2019_data[, using3m_meth5 := fifelse(
  SEX3MO == 'YES, HAD INTERCOURSE' &
    (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') &
    PSURGSTR == 'YES',
  TRUE,
  using3m_meth5
)]

# create variable counting number of current methods
male_2017_2019_data[
  ,
  meth3m_count := rowSums(.SD),
  .SDcols = patterns('^using3m_meth')
]

# set master categorization for contraceptive use
male_2017_2019_data[,
  curr_use := factor(fcase(
    meth3m_count > 0,
      'Used at least one contraceptive method at last intercourse',
    SEX3MO != 'YES, HAD INTERCOURSE',
      'Did not have sexual intercourse with female in past 3 months',
    PXCPREG == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPRGNW == 'Yes'),
      'Last intercourse was with partner who is pregnant',
    PXTRYING == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPTRYPG == 'Yes'),
      'Last intercourse was with partner who is trying to conceive',
    FATHPOSS == 'No',
      'Physically unable to conceive',
    (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPOSS == 'No',
      'Last intercourse was with wife or cohabitating partner who is physically unable to concieve',
    default = 'Otherwise did not use contraception at last intercourse'
  ))
]

# create survey design object
male_2017_2019_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = male_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```





# Things to Investigate

* Can the difference in female and male contraceptive use rates be due to males not being aware of contraception?
    * CWPLUSE2
    * CWPLMET201
    * PXLPUSE
    * PXLPMETH01
    * PXLSXPRB
* Among those at risk for unintended pregnancy, why not using contraception (Fem: EH-2, Male: None)
* Why respondents believe themselves to be sterile (Fem: DE-2 REASIMPP & EH-2 WHYNOTPG, Male: None)
* Ever tried over lifetime and why quit (Fem: EA, DC; Male: BB)
    * Include tubal ligation and vasectomy reversal
* Review "Not Ascertained" situations and follow up with NSFG administrators
* Replicate analysis in SAS
    * Attempt single-factor categorical data analysis, e.g., whether totals of otherwise not using contraception and currently trying to conceive are different
* Experiment using chi-squared tests whether it is worth combining with 2015-2017 data for more precise estimates
