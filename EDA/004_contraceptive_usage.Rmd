---
title: "Contraceptive Usage"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
library(here)
library(knitr)
library(survey)

i_am('EDA/004_contraceptive_usage.Rmd')

source(here('R/survey_helpers.R'))
source(here('R/import.R'))

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r helper-functions}
tablena <- function(x) {
  table(x, useNA = 'always')
}

in_millions <- function(dt, round_to = 3, do_round = TRUE) {
  dt <- as.data.table(dt)
  cols <- c('estimate', 'se', '2.5 %', '97.5 %')
  sub_dt <- dt[, cols, with = FALSE] / 10^6
  if (do_round) {
    sub_dt <- round(sub_dt, round_to)
  }
  dt[, (cols) := sub_dt]
  dt
}

rounded <- function(dt, round_to = 3) {
  cols <- c('estimate', 'se', '2.5 %', '97.5 %')
  sub_dt <- round(dt[, cols, with = FALSE], round_to)
  dt[, (cols) := sub_dt]
  dt
}

has_level <- function(x, ids) {
  is.element(as.integer(x), ids)
}

standard_millions_plot <- function(data) {
  ggplot(
    data = data,
    mapping = aes(
      y = reorder(level, estimate)
    )
  ) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2
  ) +
  geom_segment(
    aes(
      yend = reorder(level, estimate),
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.075, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    labels = scales::label_number(suffix = 'M', accuracy = 1),
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  theme_bw() +
  theme(
    axis.title.y = element_blank()
  )
}

standard_proportions_plot <- function(data) {
  ggplot(
  data = data,
  mapping = aes(
    y = reorder(level, estimate)
  )
) +
  geom_point(
    aes(
      x = estimate
    ),
    size = 2
  ) +
  geom_segment(
    aes(
      yend = reorder(level, estimate),
      x = `2.5 %`,
      xend = `97.5 %`
    ),
    arrow = arrow(angle = 90, ends = 'both', length = unit(0.075, 'inches')),
    size = 0.5
  ) +
  scale_x_continuous(
    breaks = seq(0, 1, 0.1),
    expand = c(0, 0),
    labels = scales::label_percent(1),
    limits = c(0, 1)
  ) +
  scale_y_discrete(
    labels = scales::wrap_format(50)
  ) +
  theme_bw() +
  theme(
    axis.title = element_blank(),
    legend.position = 'none'
  )
}

env <- new.env()

env$estimates <- data.table()

collect_estimate <- function(est, title, domain = '', type = '', round_to = 3, plot = FALSE) {
  this_title <- title
  this_domain <- domain
  this_type <- type

  if (type == 'total') {
    dt <- in_millions(est, round_to)
  } else if (type == 'proportion') {
    dt <- rounded(est, round_to)
  } else {
    dt <- as.data.table(est)
  }
  env$estimates <- rbindlist(list(
    env$estimates[
      !(
        title == this_title &
          domain == this_domain &
          type == this_type
      )
    ],
    dt[, .(
      domain = this_domain,
      title = this_title,
      type = this_type,
      level,
      estimate,
      se,
      `2.5 %`,
      `97.5 %`
    )]
  ))

  this_estimate <- env$estimates[
    title == this_title &
      domain == this_domain &
      type == this_type
  ]

  if (plot) {
    if (type == 'proportion') {
      standard_proportions_plot(this_estimate)
    } else {
      standard_millions_plot(this_estimate)
    }
  } else {
    kable(this_estimate)
  }
}
```


# Current Usage


## Female Persons Aged 15-49

```{r fem-load-data}
fem_2017_2019 <- load_NSFG_data('2017_2019', 'FemResp')
fem_2017_2019_formats <- fem_2017_2019$Formats
```

```{r fem-process-data, dependson=c('helper-functions', 'fem-load-data')}
fem_2017_2019_data <- copy(fem_2017_2019$Data[, .(
  CASEID,
  FECUND,
  HADSEX,
  METH3M1,
  METH3M2,
  METH3M3,
  MTHUSE3,
  PSURGSTR,
  RCURPREG,
  RSURGSTR,
  SECU,
  SEST,
  SEX3MO,
  WGT2017_2019
)])

# remove sterility not from contraceptive procedure from METH3M series
fem_2017_2019_data[
  METH3M1 %in% 20:21,
  `:=`(
    METH3M1 = METH3M2,
    METH3M2 = METH3M3,
    METH3M3 = NA
  )
]
fem_2017_2019_data[
  METH3M2 %in% 20:21,
  `:=`(
    METH3M2 = METH3M3,
    METH3M3 = NA
  )
]
fem_2017_2019_data[
  METH3M3 %in% 20:21,
  `:=`(
    METH3M3 = NA
  )
]

# make existing variables factors
fem_2017_2019_data[, `:=`(
  FECUND = factorize(FECUND, 'FECUND', fem_2017_2019_formats),
  HADSEX = factorize(HADSEX, 'HADSEX', fem_2017_2019_formats),
  METH3M1 = factorize(METH3M1, 'METH3MF', fem_2017_2019_formats),
  METH3M2 = factorize(METH3M2, 'METH3MF', fem_2017_2019_formats),
  METH3M3 = factorize(METH3M3, 'METH3MF', fem_2017_2019_formats),
  MTHUSE3 = factorize(MTHUSE3, 'MTHUSE3F', fem_2017_2019_formats),
  PSURGSTR = factorize(PSURGSTR, 'Y1N5C', fem_2017_2019_formats),
  RCURPREG = factorize(RCURPREG, 'RCURPREG', fem_2017_2019_formats),
  RSURGSTR = factorize(RSURGSTR, 'Y1N5C', fem_2017_2019_formats),
  SEX3MO = factorize(SEX3MO, 'Y1N2RECF', fem_2017_2019_formats)
)]

# create boolean variables for whether each specific method is currently used
for (x in c(1:19, 22:24)) {
  set(
    fem_2017_2019_data,
    j = sprintf('using3m_meth%d', x),
    value = has_level(fem_2017_2019_data$METH3M1, x) |
      has_level(fem_2017_2019_data$METH3M2, x) |
      has_level(fem_2017_2019_data$METH3M3, x)
  )
}

# create variable counting number of current methods
fem_2017_2019_data[
  ,
  meth3m_count := rowSums(.SD),
  .SDcols = patterns('^using3m_meth')
]

# create survey design object
fem_2017_2019_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = fem_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```


```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(meth3m_count > 0),
    fem_2017_2019_svy,
    svytotal
  ),
  title = 'currently using contraception',
  type = 'total',
  domain = 'females aged 15-49 living in households in the United States'
)

collect_estimate(
  svyci(
    ~I(meth3m_count > 0),
    fem_2017_2019_svy,
    svymean
  ),
  title = 'currently using contraception',
  type = 'proportion',
  domain = 'females aged 15-49 living in households in the United States'
)
```


### Currently Using Contraception

#### Methods

##### Number of Methods Used

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~factor(meth3m_count),
    subset(fem_2017_2019_svy, meth3m_count > 0),
    svytotal
  ),
  title = 'by number of contraceptive methods used',
  domain = 'females currently using contraception',
  type = 'total'
)

collect_estimate(
  svyci(
    ~factor(meth3m_count),
    subset(fem_2017_2019_svy, meth3m_count > 0),
    svymean
  ),
  title = 'by number of contraceptive methods used',
  domain = 'females currently using contraception',
  type = 'proportion'
)
```


##### By Method Used, With Those Currently Using Multiple Methods Counted Multiple Times

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        as.formula(sprintf('~using3m_meth%d', x)),
        fem_2017_2019_svy,
        svytotal
      )[
        level == TRUE
      ][
        , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'by current contraceptive method',
  domain = 'females currently using contraception',
  type = 'total',
  plot = TRUE
) +
  labs(
    subtitle = 'with those using multiple methods counted multiple times',
    title = 'Total persons by current contraceptive method',
    x = 'Number of persons'
  )

collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        as.formula(sprintf('~using3m_meth%d', x)),
        subset(fem_2017_2019_svy, meth3m_count > 0),
        svyciprop
      )[
        , .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'by current contraceptive method',
  domain = 'females currently using contraception',
  type = 'proportion',
  plot = TRUE
) +
  labs(
    subtitle = 'with those using multiple methods counted multiple times',
    title = 'Proportion of persons by current contraceptive method'
  )
```


##### By Method Used, Among Those Currently Using One Method Exclusively

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~factor(METH3M1),
    subset(fem_2017_2019_svy, meth3m_count == 1),
    svytotal
  ),
  title = 'by current contraceptive method',
  domain = 'females currently using one method exclusively',
  type = 'total',
  plot = TRUE
) +
  labs(
    subtitle = 'among females currently using one method exclusively',
    title = 'Total persons by current contraceptive method',
    x = 'Number of persons'
  )

collect_estimate(
  svyci(
    ~factor(METH3M1),
    subset(fem_2017_2019_svy, meth3m_count == 1),
    svymean
  ),
  title = 'by current contraceptive method',
  domain = 'females currently using one method exclusively',
  type = 'proportion',
  plot = TRUE
) +
  labs(
    subtitle = 'among females currently using one method exclusively',
    title = 'Proportion of persons by current contraceptive method'
  )
```


##### By Method Used, Among Those Currently Using Multiple Methods

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        ~I(meth3m_count > 1),
        subset(
          fem_2017_2019_svy,
          fem_2017_2019_data[, get(sprintf('using3m_meth%d', x))]
        ),
        svytotal
      )[
        level == TRUE,
        .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'persons using multiple methods, by method',
  domain = 'females currently using contraception',
  type = 'total',
  plot = TRUE
) +
  labs(
    subtitle = 'among females currently contraception',
    title = 'Total persons currently using multiple contraceptive methods, by method',
    x = 'Number of persons'
  )

collect_estimate(
  rbindlist(lapply(
    c(1:19, 22:24),
    function(x) {
      svyci(
        ~I(meth3m_count > 1),
        subset(
          fem_2017_2019_svy,
          fem_2017_2019_data[, get(sprintf('using3m_meth%d', x))]
        ),
        svymean
      )[
        level == TRUE,
        .(level = x, estimate, se, `2.5 %`, `97.5 %`)
      ]
    }
  ))[
    order(-estimate),
    .(
      level = factorize(level, 'METH3MF', fem_2017_2019_formats),
      estimate, se, `2.5 %`, `97.5 %`
    )
  ],
  title = 'persons using multiple methods, by method',
  domain = 'females currently using contraception',
  type = 'proportion',
  plot = TRUE
) +
  labs(
    subtitle = 'among females currently contraception',
    title = 'Proportion of persons currently using multiple contraceptive methods, by method'
  )
```


##### By Other Method Used, Among Those Currently Using Calendar Methods

```{r, dependson=c('fem-process-data')}
collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1:7, 9:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth8),
          svytotal
        )[
          level == TRUE,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      estimate > 0
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    data.table(svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth8),
        svytotal
      )[
        level == TRUE
      ][
        , .(
          level = 'Exclusively calendar rhythm, Standard Days, or Cycle Beads method',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'total',
  domain = 'females currently using calendar methods'
)

collect_estimate(
  rbindlist(list(
    rbindlist(lapply(
      c(1:7, 9:19, 22:24),
      function(x) {
        svyci(
          as.formula(sprintf('~using3m_meth%d', x)),
          subset(fem_2017_2019_svy, using3m_meth8),
          svymean
        )[
          level == TRUE,
          .(level = x, estimate, se, `2.5 %`, `97.5 %`)
        ]
      }
    ))[
      estimate > 0
    ][
      , .(
        level = factorize(level, 'METH3MF', fem_2017_2019_formats),
        estimate, se, `2.5 %`, `97.5 %`
      )
    ],
    data.table(svyci(
        ~I(meth3m_count == 1),
        subset(fem_2017_2019_svy, using3m_meth8),
        svymean
      )[
        level == TRUE
      ][
        , .(
          level = 'Exclusively calendar rhythm, Standard Days, or Cycle Beads method',
          estimate, se, `2.5 %`, `97.5 %`
        )
      ]
    )
  ))[order(-estimate)],
  title = 'by other contraceptive method',
  type = 'proportion',
  domain = 'females currently using calendar methods'
)
```



### Not Currently Using Contraception


#### Not Currently Sexually Active

```{r, dependson=c('fem-process-data')}
kable(tablena(fem_2017_2019_data$MTHUSE3))

kable(tablena(fem_2017_2019_data$SEX3MO))

kable(tablena(fem_2017_2019_data$HADSEX))

fem_2017_2019_data[MTHUSE3 == 'Not Applicable', .N] ==
  fem_2017_2019_data[SEX3MO == 'NO', .N] +
  fem_2017_2019_data[HADSEX == 'NO, R NEVER HAD INTERCOURSE', .N]
```

The respondents with `NA` for MTHUSE3 are respondents with "NO" for `SEX3MO` plus the respondents with "NO, R NEVER HAD INTERCOURSE" for `HADSEX`. Both these variables must be checked to estimate females who are not currently sexually active with a male.

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(SEX3MO == 'NO' | HADSEX == 'NO, R NEVER HAD INTERCOURSE'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  ),
  title = 'did not have intercourse with male in previous 3 months',
  type = 'total',
  domain = 'females not currently using contraception' 
)

collect_estimate(
  svyci(
    ~I(SEX3MO == 'NO' | HADSEX == 'NO, R NEVER HAD INTERCOURSE'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svymean
  ),
  title = 'did not have intercourse with male in previous 3 months',
  type = 'proportion',
  domain = 'females not currently using contraception' 
)
```

Females not currently sexually active with a male accounts for the majority not using contraception. This can be further decomposed by never had sex with male versus just not currently.


#### Pregnant

```{r, dependson=c('fem-process-data')}
fem_2017_2019_data[, tablena(RCURPREG)]
```

The pregnancy recode variable is straightforward.

Going forward, estimates of those not currently using contraception will be cumulatively exclusive of previous estimates. For instance, those who are both pregnant and not currently sexually active will be counted once as not currently sexually active. Only those preganant and currently sexually active will be included in the next estimate.

```{r, dependson=c('fem-process-data')}
collect_estimate(
  svyci(
    ~I(RCURPREG == 'YES (CURRENTLY PREGNANT)' & SEX3MO == 'YES'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svytotal
  ),
  title = 'currently pregnant and had sexual intercourse with male in previous 3 months',
  type = 'total',
  domain = 'females not currently using contraception' 
)

collect_estimate(
  svyci(
    ~I(RCURPREG == 'YES (CURRENTLY PREGNANT)' & SEX3MO == 'YES'),
    subset(fem_2017_2019_svy, meth3m_count == 0),
    svymean
  ),
  title = 'currently pregnant and had sexual intercourse with male in previous 3 months',
  type = 'proportion',
  domain = 'females not currently using contraception' 
)
```


#### Reason for Not Using Contraception

Section EH are questions asked of respondent to determine reason for not using contraception. The universe is 

> Applicable if R is not currently pregnant (currpreg = 5) and R had sex in month of interview (EC-8 MONSX through MONSX48 corresponding to cmintvw = 1) and R is not sterilized nor sterile [(rstrstat ne 1 or 2) and (ED-6 METHX1 through METHX192 corresponding to cmintvw ne 6)] and R did not use a method in month of interview (currmeth1 = 1)

This might not line up nicely with the `MTHUSE3` and `SEX3MO` variables, since Section EH is asked for those who had sex with a male in the current month and `MTHUSE3` and `SEX3MO` refer to past 3 months. Once analysis gets to Section EH, different variables will have to be used in order to make the denominator consistent.


#### Infertile Due to Reasons Others Than Contraception

```{r, dependson=c('fem-process-data')}
kable(
  fem_2017_2019_data[
    meth3m_count == 0 & has_level(MTHUSE3, 2:3) & as.integer(FECUND) == 1,
    .(CASEID, meth3m_count, MTHUSE3, FECUND, RSURGSTR, PSURGSTR)
  ]
)
```

This appears inconsistent. It shouldn't be possible to have `FECUND` of "SURGICALLY STERILE, CONTRACEPTIVE" and to not have used a contraceptive at last intercourse, unless, perhaps, the surgery happened in between the last intercourse and the interview, which seems unlikely. `FECUND` takes into account partner's sterilization, but partner being sterilized contraceptively and respondent not only accounts for 2 rows in this inconsistency. There might be something going on with contraceptive surgical sterilization not counting as contraceptive in respondent's minds or something. Or perhaps this is the result of statistical perturbation done unwell.

Generally, I don't think I should rely on the `FECUND` or `INFERT` recodes. I still want to count this kind of not using contraception while still engaged in sexual intercourse with a male, so I'll calculate infertility separately, perhaps using the recode logic as a guide.


## To Do

* Use svyciprop instead of svymean
* Finish estimating current non-users
* Calculate overall current contraceptive usage rate
* Check everything against `CONSTAT` series recodes


## Male Persons Aged 15-49

```{r male-load-data}
male_2017_2019 <- load_NSFG_data('2017_2019', 'Male')
```

```{r male-process-data, dependson=c('helper-functions', 'male-load-data')}
male_2017_2019_data <- copy(male_2017_2019$Data)

male_svy <- svydesign(
  ids = ~SECU,
  strata = ~SEST,
  data = male_2017_2019_data,
  nest = TRUE,
  weights = ~WGT2017_2019
)
```

According to the U.S. Census Bureau, ibid. The number of civilian noninstitutionalized male persons in the United States is ~74,238,000.


# Outline

## Frames for analysis

### By Table

* Female persons
* Male persons

### By Columns

* "Current" -- at last intercourse with male in past 3 months
* "Recent" -- over previous year
* "Ever" -- over lifetime

## Questions for Users

* Which contraceptives?
* How many?
* For reasons other than contraception?
* For "recent," how consistent?
* For "recent" and for multiple methods users, simultaneously or alternatively?
* For "ever" and who have stopped using a method, why did they stop?

## Questions for Nonusers

* Not sexually active with male?
    * Ever or just now?
    * Exclusively same-sex partner(s)?
* Currently pregnant?
* Noncontraceptive surgical sterilization
* Physically unable to have child
* Cohabitating partner or husband surgical sterilization
* Cohabitating partner or husband physically unable to have child
* Trying to get pregnant?
* For those fertile, heterosexually active, not using contraception, and not desiring pregnancy, why no contraception usage?

## Covariates/Subdomains

* Want children in future, but not just not now
* By sex education
* By income
* By religion
    * Roman Catholics are a subdomain of interest.
* Second phase vs. first-phase (to investigate nonresponse bias)

## Other

* Try combining with 2015-2017 data for more precise estimates?
