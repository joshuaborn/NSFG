---
title: "Contraceptive Use Intervals in 2002 NSFG (Cycle 6)"
author: "Joshua Born"
output:
  html_document:
    code_folding: show
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

i_am('EDA/015_contraceptive_use_intervals_2002.Rmd')

source(here('R/NSFG_helpers.R'))
source(here('R/general_helpers.R'))

opts_chunk$set(
  cache = TRUE,
  dpi = 72,
  echo = TRUE,
  fig.align = 'center',
  fig.asp = 0.5,
  fig.retina = 2,
  fig.width = 10
)
```

```{r load-data}
fem2002 <- load_NSFG_data('2002', 'FemResp')
preg2002 <- load_NSFG_data('2002', 'FemPreg')
```

```{r process-data, dependson='load-data'}
fem2002dt <- copy(fem2002$Data)
```


## Contraceptive Calendar Variables

```{r explore-variables, dependson='process-data'}
tablena(fem2002dt$EVERUSED)
```

### CMSTRTMC

Century month for date of starting month of method calendar (computed)

```{r explore-CMSTRTMC, dependson='process-data'}
fem2002dt[EVERUSED == 1, tablena(CMSTRTMC)] |>
  names_to_century_month() |> kable()
```

### CMENDMC

Century month for date of ending month of method calendar (computed)

```{r explore-CMENDMC, dependson='process-data'}
fem2002dt[EVERUSED == 1, table(CMENDMC)] |>
  names_to_century_month() |>
  kable()
```

### CMDATBGN

Date (century month) began using method/method combination (computed)

```{r explore-CMDATBGN, dependson='process-data'}
fem2002dt[EVERUSED == 1, table(CMDATBGN)] |>
  names_to_century_month()
```

### MONSX series

These variables indicate whether or not the respondent had intercourse in the specified month. (computed)

```{r explore-MONSX-1, dependson='process-data'}
fem2002$Formats[format_name == 'MONSX']
```

For some reason, the format in the provided SAS statements is incomplete, so I will just set the factor labels manually.

```{r explore-MONSX, dependson='process-data'}
fem2002calendar <- melt(
  fem2002dt,
  id.vars = c('CASEID'),
  measure.vars = patterns('^MONSX[[:digit:]]+'),
  value.name = 'MONSX'
)

fem2002calendar[,
  cm_value := as.integer(sub(
    '^MONSX([[:digit:]]+)',
    '\\1',
    variable
  ))
]

fem2002calendar[, `:=`(
  cm_label = to_century_month(cm_value),
  variable = NULL,
  MONSX_f = factor(
    MONSX,
    levels = c(1, 5, 7, 8, 9),
    labels = c('YES', 'NO', 'NOT ASCERTAINED', 'REFUSED', "DON'T KNOW")
  )
)]

setkeyv(fem2002calendar, c('CASEID', 'cm_value'))

setcolorder(fem2002calendar, c('CASEID', 'cm_value', 'cm_label'))

fem2002calendar |> head(30) |> kable()

fem2002calendar[, tablena(MONSX_f)] |> kable()
```


### NUMMULT series

These variables indicate the number of methods reported in a given month. (computed)

```{r explore-NUMMULT-1, dependson='process-data'}
grep('^NUMMULT[[:digit:]]*', names(fem2002dt), value = TRUE)
```

Unlike `MONSX`, these variable names do not use the century-month encoding.

```{r explore-NUMMULT-2, dependson='explore-MONSX'}
NUMMULT_pivot <- melt(
  fem2002dt,
  id.vars = c('CASEID'),
  measure.vars = patterns('^NUMMULT[[:digit:]]*'),
  value.name = 'NUMMULT'
)[, .(
  CASEID,
  NUMMULT,
  month_offset = as.integer(sub(
    '^NUMMULT([[:digit:]]*)',
    '\\1',
    variable
  ))
)][, .(
  CASEID,
  NUMMULT,
  cm_value = fifelse(
    is.na(month_offset),
    1189L, # This is January 1999.
    1188L + month_offset
  )
)]

fem2002calendar[
  NUMMULT_pivot,
  NUMMULT := i.NUMMULT,
  on = c('CASEID', 'cm_value')
]

fem2002calendar |> head(30) |> kable()

fem2002calendar[, tablena(NUMMULT)] |> kable()

NUMMULT_pivot[, max(cm_value)]
fem2002calendar[, max(cm_value)]

NUMMULT_pivot[, min(cm_value)]
fem2002calendar[, min(cm_value)]
```

It appears that the NUMMULT series begins in January 1999 (century-month 1189), but the MONSX series begins a year earlier in January 1998 (century-month 1177).


### METHHIST series

This series of variables encode up to 4 methods of contraception mentioned by respondents as used in a given month.

```{r explore-METHHIST-1, dependson='process-data'}
METHHIST_colnames <- grep('^METHHIST[[:digit:]]*', names(fem2002dt), value = TRUE)
METHHIST_colnames
```

The first two digits in the numerical suffix refer to the month, and the last digit of the numerical suffix numbers the mentions.

```{r explore-METHHIST-2, dependson= 'explore-METHHIST-1'}
sapply(fem2002dt[, ..METHHIST_colnames], class)

fem2002dt[, tablena(METHHIST514)]
```

`METHHIST514` is being loaded into R as a boolean variable because it is all `NA` values. It needs to be casted into an integer variable for pivoting.

```{r explore-METHHIST-3, dependson='explore-NUMMULT-2'}
fem2002dt[, METHHIST514 := as.integer(METHHIST514)]

METHHIST_long <- melt(
  fem2002dt,
  id.vars = c('CASEID'),
  measure.vars = patterns('^METHHIST[[:digit:]]*'),
  value.name = 'METHHIST'
)[, .(
  CASEID,
  METHHIST,
  month_offset = as.integer(sub(
    '^METHHIST([[:digit:]]{2,2})[[:digit:]]',
    '\\1',
    variable
  )),
  mention_num = as.integer(sub(
    '^METHHIST[[:digit:]]{2,2}([[:digit:]])',
    '\\1',
    variable
  ))
)][, .(
  CASEID,
  cm_value =  1188L + month_offset,
  METHHIST,
  METHHIST_f = factorize_NSFG_variable(
    METHHIST,
    'TE_157F',
    formats_table = fem2002$Formats,
    fill_na = FALSE
  ),
  mention_num
)]

METHHIST_wide <- dcast(
  METHHIST_long,
  CASEID + cm_value ~ mention_num,
  value.var = c('METHHIST', 'METHHIST_f')
)

fem2002calendar[
  METHHIST_wide,
  `:=`(
    METHHIST_1 = i.METHHIST_1,
    METHHIST_f_1 = i.METHHIST_f_1,
    METHHIST_2 = i.METHHIST_2,
    METHHIST_f_2 = i.METHHIST_f_2,
    METHHIST_3 = i.METHHIST_3,
    METHHIST_f_3 = i.METHHIST_f_3,
    METHHIST_4 = i.METHHIST_4,
    METHHIST_f_4 = i.METHHIST_f_4
  ),
  on = c('CASEID', 'cm_value')
]

fem2002calendar[CASEID == 15, 1:8] |> kable()
```

```{r explore-METHHIST-4, dependson='explore-METHHIST-3'}
METHHIST_long[, tablena(METHHIST_f)]
```

Fortunately, the "SAME METHOD USED THRU END OF YEAR" and "SAME AS PREVIOUS MONTH" levels of `METHHIST` are not used.


### Remaining

* MTHUSIMX series
* SIMSEQ series


## Notes

* Look at the dates for sterilizing operations and override contraceptive use calendars with this information.
* Handle non-contraceptive sterility for both
    * respondent and
    * respondent's partner.
* Going forward doing analysis on different years of the NSFG, having the NSFG helper functions set and get variables is going to be unwieldy. I should remove that and just pass in the relevant tables as function parameters.
