---
title: "Number of Births"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(dplyr)
library(here)
library(readr)
library(srvyr)
library(stringr)
library(survey)

here::i_am(file.path('eda', 'number_of_births.Rmd'))

knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE
)
```

## During 2012-2016, Based on 2017-2019 Data

[Appendix 2 to the User Guide for the 2017-2019 NSFG](https://www.cdc.gov/nchs/nsfg/nsfg_2017_2019_puf.htm) contains point estimates and confidence intervals of the number of live births during 2012-2016 in the United States, based on the 2017-2019 NSFG. These estimates are in turn compared with births registered through the National Vital Statistics System to verify their accuracy. See Table 1.

In order to validate the NSFG data are being used correctly with the `survey` package viz a viz weights, pseudo-strata, and pseudo-clusters, and in order to motivate familiarization with the NSFG data set, these point estimates and these confidence intervals are replicated here.

```{r table1, echo=FALSE, fig.cap='**Table 1:** A table of estimates of births in the United States from page 2 of the Appendix 2 to the User Guide for the 2017-2019 NSFG.'}
knitr::include_graphics(file.path('img', '2017_2019_births_table.png'))
```

```{r load-data, message=FALSE, cache=TRUE}
source(here('src', 'load_data.R'))
preg_2019_data <- load_nsfg_data(2019, 'Preg')
```


### Variables for Filtering

The estimates in Table 1 can be calculated from data in the female pregnancy file (`2017_2019_Preg.dat`). The filtering necessary for these estimates appear to be based on variables for pregnancy outcome (`OUTCOME`), year pregnancy ended (`DATEND`), whether respondent was born outside of the United States (`BRNOUT`), and the year the respondent came to the United States (`YRSTRUS`).

The `OUTCOME` and `DATEND` are recoded variables, whereas `BRNOUT` is a raw variable.

```{r check-outcome}
count(
  data.frame(Outcome = factor(
    preg_2019_data$OUTCOME,
    labels = c(
      'LIVE BIRTH',
      'INDUCED ABORTION',
      'STILLBIRTH',
      'MISCARRIAGE',
      'ECTOPIC PREGNANCY',
      'CURRENT PREGNANCY'
    )
  )),
  Outcome
)
```

The counts of each level of the `OUTCOME` variable match the counts reported in the codebook.

```{r check-datend}
count(
  preg_2019_data,
  INAPPLICABLE = is.na(DATEND)
)
```

The are 193 observations for which `DATEND` is inapplicable and 10,022 otherwise, which matches what is reported in the codebook.

```{r check-brnout}
count(
  data.frame(BRNOUT = factor(
    preg_2019_data$BRNOUT,
    labels = c('Yes', 'No', 'Refused', "Don't Know")
  )),
  BRNOUT
)
```

The counts of each level of the `BRNOUT` variable matches what is in the codebook.

The `YRSTRUS` variable does not appear to be documented in the 2017-2019 NSFG documentation. The last time it appears in the Female Pregnancy File Codebook is in the 2015-2017 NSFG documentation, which references Appendix 7 of the User Guide. However, only the `STRUS_M`, `STRUS_F`, and `CMSTRUS` variables are discussed in Appendix 7 in the 2015-2017 NSFG documentation. These variables contain the month and year that a respondent came to United States, if the respondent is born elsewhere, and are not released in the public use data files due to disclosure risk.

The Appendix 7 in the 2013-2015 NSFG documentation does discuss the `YRSTRUS` variable, stating that it contains a calculated value indicating only the year the respondent came to stay in the United States. However, as seen below, there are only the values 1, 2, 3, or 4 contained in the `YRSTRUS` data for the 2017-2019 NSFG data set, in addition to values customarily used to encode for "refused" and "don't know" responses and to encode for non-applicability.

```{r check-yrstrus}
preg_2019_data %>%
  group_by(YRSTRUS) %>%
  count()
```

Fortunately, even though the 2017-2019 encoding of the `YRSTRUS` variable is not documented anywhere, the SAS program statement for the female pregnancy file contains a values definition for the variable.

```{sas, eval=FALSE}
  value YRSTRUS
     1 = '1968-1989'  
     2 = '1990-1999'  
     3 = '2000-2009'  
     4 = '2010-2019'  
     98 = 'Refused'  
     99 = 'Don''t know' ;
```

```{r check-yrstrus2}
count(
  data.frame(YRSTRUS = factor(
    preg_2019_data$YRSTRUS,
    labels = c(
      '1968-1989',
      '1990-1999',
      '2000-2009',
      '2010-2019',
      'Refused',
      "Don't know"
    )
  )),
  YRSTRUS
)
```

It appears as though the `YRSTRUS` in the 2017-2019 public use files has been modified even more than in previous iterations of the public use files. Because the estimates of Table 1 are of live births in the United States from 2012-2016, the only possible use of the `YRSTRUS` variable for calculating Table 1 estimates is to filter out observations with value `4` of the `YRSTRUS`, which consists of 355 observations. However, this also filters out some observations of births that did occur in the United States. Therefore, the estimates are calculated both with and without these observations, to verify if such filtering changes the estimates substantially.


### Estimates Using Unwrapped `survey` Package

```{r check-strat-and-id}
preg_2019_data %>%
  group_by(SEST, SECU) %>%
  count()
```

The pseudo-stratum and pseudo-PSU identifiers appear to be nested.

```{r specify-survey-design}
preg_2019_data$OUTCOME <- factor(
  preg_2019_data$OUTCOME,
  labels = c(
    'LIVE BIRTH',
    'INDUCED ABORTION',
    'STILLBIRTH',
    'MISCARRIAGE',
    'ECTOPIC PREGNANCY',
    'CURRENT PREGNANCY'
  )
)

preg_2019_data$YRSTRUS <- factor(
  preg_2019_data$YRSTRUS,
  labels = c(
    '1968-1989',
    '1990-1999',
    '2000-2009',
    '2010-2019',
    'Refused',
    "Don't know"
  )
)

preg_2019_data$Births <- ifelse(
  preg_2019_data$OUTCOME == 'LIVE BIRTH',
  1,
  0
)

preg_2019_data$HISPRACE2 <- factor(
  preg_2019_data$HISPRACE2,
  labels = c(
    'Hispanic',
    'Non-Hispanic White, Single Race',
    'Non-Hispanic Black, Single Race',
    'Non-Hispanic Other or Multiple Race'
  )
)

preg_2019_data$FMAROUT5 <- factor(
  preg_2019_data$FMAROUT5,
  labels = c(
    'MARRIED',
    'DIVORCED',
    'WIDOWED',
    'SEPARATED',
    'NEVER MARRIED'
  )
)

preg_2019_data$MarriedAtBirth <- factor(
  ifelse(preg_2019_data$FMAROUT5 == 'MARRIED', 'Married', 'Unmarried')
)

preg_2019_data$AgeAtDelivery <- cut(
  preg_2019_data$AGEPREG,
  c(seq(15, 30, 5), 40, 50),
  right = FALSE
)

preg_2019_data$BirthOrder <- factor(
  ifelse(preg_2019_data$BIRTHORD >= 3, 3, preg_2019_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

preg_2019_svy <- svydesign(
  data = preg_2019_data,
  strat = ~SEST,
  id = ~SECU,
  weight = ~WGT2017_2019,
  nest = TRUE
)

preg_2019_svy
```


#### Total

```{r, total-births}
births_2019_svy <- subset(
  preg_2019_svy,
  DATEND >= 2012 & DATEND <= 2016
)

births_us_2019_svy <- subset(
  births_2019_svy,
  is.na(YRSTRUS) | YRSTRUS != '2010-2019'
)

births_2019_stat <- svytotal(~Births, births_2019_svy)

births_us_2019_stat <- svytotal(~Births, births_us_2019_svy)

births_2019_stat

births_us_2019_stat
```

As expected, the estimate without attempting to filter births occurring outside the United States is too high, the estimate that filters out births for respondents who came to the United States in the 2010-2019 time period is too low, since such filtering also filters some births occuring in the United States.

```{r, total-birth-CIs}
knitr::kable(
  format(
    round(
      cbind(
        coef(births_2019_stat),
        confint(births_2019_stat, df = degf(preg_2019_svy))
      ) / 1000
    ),
    big.mark = ','
  ),
  caption = '**Table 2:** Estimates of live births (in thousands) during 2012-2016 based on the NSFG without filtering on `YRSTRUS`.'
)

knitr::kable(
  format(
    round(
      cbind(
        coef(births_us_2019_stat),
        confint(births_us_2019_stat, df = degf(preg_2019_svy))
      ) / 1000
    ),
    big.mark = ','
  ),
  caption = '**Table 3:** Estimates of live births (in thousands) during 2012-2016 with filtering on `YRSTRUS != 4`.'
)
```

The confidence intervals seem reasonable compared to the confidence interval for total births in Table 1. The lower bound of the confidence interval without filtering on `YRSTRUS` in Table 2 is very close to the lower bound in Table 1, and the upper bound of the confidence interval with filtering on `YRSTRUS` in Table 3 is very close to the upper bound in Table 1.


#### By Year of Delivery

```{r by-year-of-delivery}
svyby(
  ~Births,
  ~DATEND,
  svytotal,
  design = births_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~DATEND,
  svytotal,
  design = births_us_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

The estimated number of births for each year without any attempt to eliminate births outside the United States are overestimates compared with Table 1, while filtering births to those respondents who came to the United States during 2010-2019 results in underestimates compared with Table 1, as expected.


#### By Hispanic Origin and Racial Classification

```{r by-hispanic-origin-and-racial-classification}
svyby(
  ~Births,
  ~HISPRACE2,
  svytotal,
  design = births_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~HISPRACE2,
  svytotal,
  design = births_us_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

Estimated number of births in the subpopulation categorized "Hispanic or Latina" is an overestimate when compared with Table 1 without any filtering for births outside the United States, and an underestimate when filtering by respondents who came to the United States during 2010-2019. Unlike other subpopulations, both subpopulations under "Not Hispanic" have underestimates for number of births compared with Table 1, regardless of whether or not filtering based on time respondent came to United States is done.


#### By Martial Status at Birth

```{r by-martial-status-at-birth}
svyby(
  ~Births,
  ~MarriedAtBirth,
  svytotal,
  design = births_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~MarriedAtBirth,
  svytotal,
  design = births_us_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

The estimates for number of births for the married and unmarried subpopulations bracket the estimates in Table 1 as described in other sections.


#### By Age at Delivery

```{r by-age-at-delivery}
svyby(
  ~Births,
  ~AgeAtDelivery,
  svytotal,
  design = births_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~AgeAtDelivery,
  svytotal,
  design = births_us_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

The estimates for number of births for the subpopulations by age of mother at delivery bracket the estimates in Table 1 as described in other sections.


#### By Birth Order

```{r by-birth-order}
svyby(
  ~Births,
  ~BirthOrder,
  svytotal,
  design = births_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~BirthOrder,
  svytotal,
  design = births_us_2019_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

The estimates for number of births for subpopulations by birth order bracket the estimates in Table 1 as described in other sections.


### Estimates Using `srvyr` Package

The `srvyr` package wraps the `survey` package providing a tidyverse-like interface. In this section, the estimates calculated above are replicated using the `srvyr` package.

```{r srvyr}
generate_birth_estimates_table <- function(srvyr_tbl,
                                           origin_var = 'HISPRACE2',
                                           year_end_var = 'DATEND') {
  format_births <- function(raw) {
    format(
      round(raw / 1000),
      big.mark = ',',
      width = 5
    )
  }

  subpopulation_helper <- function(varname, label) {
    srvyr_tbl %>%
      group_by(!!sym(varname)) %>%
      summarize(
        Births = survey_total(Births, vartype = 'ci')
      ) %>%
      rename(Subpopulation = !!sym(varname)) %>%
      mutate(across(starts_with('Births'), format_births)) %>%
      transmute(
        Subpopulation = Subpopulation,
        `Point Estimate` = Births,
        `95% Confidence Interval` = paste(Births_low, Births_upp, sep = ' - ')
      ) %>%
      mutate(Label = label, .before = 1)
  }

  total_row <- srvyr_tbl %>%
    summarize(
      Births = survey_total(Births, vartype = 'ci')
    ) %>%
    mutate(across(starts_with('Births'), format_births)) %>%
    transmute(
      `Point Estimate` = Births,
      `95% Confidence Interval` = paste(Births_low, Births_upp, sep = ' - ')
    ) %>%
    mutate(
      Label = 'Total',
      Subpopulation = NA,
      .before = 1
    )

  rbind(
    total_row,
    subpopulation_helper(year_end_var, 'By year of delivery'),
    subpopulation_helper(origin_var, 'By origin and race'),
    subpopulation_helper('MarriedAtBirth', 'By marital status at birth'),
    subpopulation_helper('AgeAtDelivery', 'By age at delivery') %>%
      filter(!is.na(Subpopulation)),
    subpopulation_helper('BirthOrder', 'By birth order') %>%
      filter(!is.na(Subpopulation))
  )
}

births_2019_srvyr <- preg_2019_data %>%
  as_survey(
    strata = SEST,
    ids = SECU,
    weights = WGT2017_2019,
    nest = TRUE
  ) %>%
  filter(
    DATEND >= 2012 & DATEND <= 2016
  )

knitr::kable(
  generate_birth_estimates_table(births_2019_srvyr),
  align = 'llrr',
  caption = '**Table 4:** Number of births in thousands during 2012-2016 estimated from NSFG 2017-2019 data, including some births that occurred outside of United States.'
)

births_us_2019_srvyr <- births_2019_srvyr %>%
  filter(
    is.na(YRSTRUS) | YRSTRUS != '2010-2019'
  )

knitr::kable(
  generate_birth_estimates_table(births_us_2019_srvyr),
  align = 'llrr',
  caption = '**Table 5:** Number of births in thousands during 2012-2016 estimated from NSFG 2017-2019 data, not including births of respondents who came to United States during 2010-2019.'
)
```

Using `tidyverse` processing facilitated by `srvyr`, it is relatively easy to collect the statistics into a single table.


## During 2010-2014, Based on 2015-2017 Data

The documentation for the 2015-2017 NSFG has a table similar to Table 1, except in its main User Guide instead of in an appendix. It is reproduced as Table 6.

```{r table6, echo=FALSE, fig.cap='**Table 6:** A table of estimates of births in the United States  taken from Part 2 of the User Guide for the 2015-2017 NSFG.'}
knitr::include_graphics(file.path('img', '2015_2017_births_table.png'))
```

```{r repeated-2015-2017}
preg_2017_data <- load_nsfg_data(2017, 'Preg')

preg_2017_data$Births <- as.integer(preg_2017_data$OUTCOME == 1)

preg_2017_data$BeforeInUs <- (
  preg_2017_data$DATEND < preg_2017_data$YRSTRUS
)

preg_2017_data$HISPRACE <- factor(
  preg_2017_data$HISPRACE,
  labels = c(
    'Hispanic',
    'Non-Hispanic White',
    'Non-Hispanic Black',
    'Non-Hispanic Other'
  )
)

preg_2017_data$MarriedAtBirth <- factor(
  ifelse(preg_2017_data$FMAROUT5 == 1, 'Married', 'Unmarried')
)

preg_2017_data$AgeAtDelivery <- cut(
  preg_2017_data$AGEPREG,
  c(seq(15, 30, 5), 40, 50),
  right = FALSE
)

preg_2017_data$BirthOrder <- factor(
  ifelse(preg_2017_data$BIRTHORD >= 3, 3, preg_2017_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

preg_2017_data %>%
  as_survey(
    strata = SEST,
    ids = SECU,
    weights = WGT2015_2017,
    nest = TRUE
  ) %>%
  filter(
    DATEND >= 2010,
    DATEND <= 2014,
    is.na(BeforeInUs) | !BeforeInUs
  ) %>%
  generate_birth_estimates_table(origin_var = 'HISPRACE') %>%
  knitr::kable(
    align = 'llrr',
    caption = '**Table 7:** Number of births in thousands during 2010-2014 estimated from NSFG 2015-2017 data, not including births in year earlier than year respondents came to United States.'
  )
```

The number of live births estimates for 2010-2014 based on the 2015-2017 data are summarized in Table 7. The estimates in Table 7 are much closer to those reported in Table 6 than seen with the 2017-2019 data set. This likely due to the 2015-2017 data set using a `YRSTRUS` with much more granularity than the 2017-2019 data set.

Indeed, the estimates for subpopulations with 2011, 2012, 2013 and 2014 year of delivery, with "Non-Hispanic White" and "Non-Hispanic Black" categorization, with marital status at birth of married, and with "2nd" or "3rd or higher" birth order in Table 7 are exactly the point estimates and confidence intervals reported in Table 6.

The slight overestimate in the total number of live births for certain subpopulations in Table 7 is likely due to the availability only of year, but not month, of birth and year, but not month, a respondent came to the United States in public use data files. Table 6 was likely generated with more precise dates. Therefore, some births that occurred outside the United States are included in the calculation of the estimates in Table 7.


## During 2008-2012, Based on 2013-2015 Data

No set of estimates similar to Table 1 or Table 6 are released with the 2013-2015 NSFG, either in the User Guide or in a separate paper. For completeness and to verify correct loading of the data set, live birth estimates are still generated here.

```{r repeated-2013-2015}
preg_2015_data <- load_nsfg_data(2015, 'Preg')

preg_2015_data$Births <- as.integer(preg_2015_data$OUTCOME == 1)

preg_2015_data$YearEnd <- floor(preg_2015_data$DATEND / 12) + 1900

preg_2015_data$BeforeInUs <- (
  preg_2015_data$YearEnd < preg_2015_data$YRSTRUS
)

preg_2015_data$HISPRACE <- factor(
  preg_2015_data$HISPRACE,
  labels = c(
    'Hispanic',
    'Non-Hispanic White',
    'Non-Hispanic Black',
    'Non-Hispanic Other'
  )
)

preg_2015_data$MarriedAtBirth <- factor(
  ifelse(preg_2015_data$FMAROUT5 == 1, 'Married', 'Unmarried')
)

preg_2015_data$AgeAtDelivery <- cut(
  preg_2015_data$AGEPREG,
  c(0, 2000, 2500, 3000, 4500),
  right = FALSE,
  labels = c(
    'UNDER 20 YEARS',
    '20-24 YEARS',
    '25-29 YEARS',
    '30-44 YEARS'
  )
)

preg_2015_data$BirthOrder <- factor(
  ifelse(preg_2015_data$BIRTHORD >= 3, 3, preg_2015_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

preg_2015_data %>%
  as_survey(
    strata = SEST,
    ids = SECU,
    weights = WGT2013_2015,
    nest = TRUE
  ) %>%
  filter(
    YearEnd >= 2008,
    YearEnd <= 2012,
    is.na(BeforeInUs) | !BeforeInUs
  ) %>%
  generate_birth_estimates_table(
    origin_var = 'HISPRACE', year_end_var = 'YearEnd'
  ) %>%
  knitr::kable(
    align = 'llrr',
    caption = '**Table 8:** Number of births in thousands during 2008-2012 estimated from NSFG 2013-2015 data, not including births in year earlier than year respondents came to United States.'
  )
```

These estimates could be checked against birth registration counts from National Vital Statistics System.


## During 2006-2010, Based on 2011-2013 Data

The User Guide for the 2011-2013 NSFG does contain a table of estimates similar to Table 1 or Table 6, though it does not contain estimates for subpopulations by year of birth. It is reproduced as Table 9.

```{r table9, echo=FALSE, fig.cap='**Table 9:** A table of estimates of births in the United States taken from Part 2 of the User Guide for the 2011-2013 NSFG.'}
knitr::include_graphics(file.path('img', '2011_2013_births_table.png'))
```

```{r repeated-2011-2013}
preg_2013_data <- load_nsfg_data(2013, 'Preg')

preg_2013_data$Births <- as.integer(preg_2013_data$OUTCOME == 1)

preg_2013_data$YearEnd <- floor(preg_2013_data$DATEND / 12) + 1900

preg_2013_data$BeforeInUs <- (
  preg_2013_data$YearEnd < preg_2013_data$YRSTRUS
)

preg_2013_data$HISPRACE <- factor(
  preg_2013_data$HISPRACE,
  labels = c(
    'Hispanic',
    'Non-Hispanic White',
    'Non-Hispanic Black',
    'Non-Hispanic Other'
  )
)

preg_2013_data$MarriedAtBirth <- factor(
  ifelse(preg_2013_data$FMAROUT5 == 1, 'Married', 'Unmarried')
)

preg_2013_data$AgeAtDelivery <- cut(
  preg_2013_data$AGEPREG,
  c(0, 2000, 2500, 3000, 4500),
  right = FALSE,
  labels = c(
    'UNDER 20 YEARS',
    '20-24 YEARS',
    '25-29 YEARS',
    '30-44 YEARS'
  )
)

preg_2013_data$BirthOrder <- factor(
  ifelse(preg_2013_data$BIRTHORD >= 3, 3, preg_2013_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

preg_2013_data %>%
  as_survey(
    strata = SEST,
    ids = SECU,
    weights = WGT2011_2013,
    nest = TRUE
  ) %>%
  filter(
    YearEnd >= 2006,
    YearEnd <= 2010,
    is.na(BeforeInUs) | !BeforeInUs
  ) %>%
  generate_birth_estimates_table(
    origin_var = 'HISPRACE', year_end_var = 'YearEnd'
  ) %>%
  knitr::kable(
    align = 'llrr',
    caption = '**Table 10:** Number of births in thousands during 2006-2010 estimated from NSFG 2011-2013 data, not including births in year earlier than year respondents came to United States.'
  )
```

The estimates calculated from the 2011-2013 data set that are summarized in Table 10 are very close to those reported in Table 9. The differences are likely due to the lack of precision in the public use data files regarding respondents' time of entry to the United States.


## During 2002-2006, Based on 2006-2010 Data

While the User Guide for the 2006-2010 NSFG data set does contain a table of birth estimates, like Table 9 the table in the User Guide does not have estimates for subpopulations based on year of birth. The paper by Martinez, et al (2012) contains a table of birth estimates with the year of birth subpopulation estimates. It is replicated as Table 11.

```{r table11, echo=FALSE, fig.cap='**Table 11:** A table taken from Martinez, et al (2012) containing estimates of number of births in the United States during 2002-2006 based on NSFG 2006-2010 data.'}
knitr::include_graphics(file.path('img', '2006_2010_births_table.png'))
```

```{r repeated-2006-2010}
preg_2010_data <- load_nsfg_data(2010, 'Preg')

preg_2010_data$Births <- as.integer(preg_2010_data$OUTCOME == 1)

preg_2010_data$YearEnd <- floor(preg_2010_data$DATEND / 12) + 1900

preg_2010_data$BeforeInUs <- (
  preg_2010_data$YearEnd < preg_2010_data$YRSTRUS
)

preg_2010_data$HISPRACE <- factor(
  preg_2010_data$HISPRACE,
  labels = c(
    'Hispanic',
    'Non-Hispanic White',
    'Non-Hispanic Black',
    'Non-Hispanic Other'
  )
)

preg_2010_data$MarriedAtBirth <- factor(
  ifelse(preg_2010_data$FMAROUT5 == 1, 'Married', 'Unmarried')
)

preg_2010_data$AgeAtDelivery <- cut(
  preg_2010_data$AGEPREG,
  c(0, 2000, 2500, 3000, 4500),
  right = FALSE,
  labels = c(
    'UNDER 20 YEARS',
    '20-24 YEARS',
    '25-29 YEARS',
    '30-44 YEARS'
  )
)

preg_2010_data$BirthOrder <- factor(
  ifelse(preg_2010_data$BIRTHORD >= 3, 3, preg_2010_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

preg_2010_data %>%
  as_survey(
    strata = SEST,
    ids = SECU,
    weights = WGTQ1Q16,
    nest = TRUE
  ) %>%
  filter(
    YearEnd >= 2002,
    YearEnd <= 2006,
    is.na(BeforeInUs) | !BeforeInUs
  ) %>%
  generate_birth_estimates_table(
    origin_var = 'HISPRACE', year_end_var = 'YearEnd'
  ) %>%
  knitr::kable(
    align = 'llrr',
    caption = '**Table 12:** Number of births in thousands during 2002-2006 estimated from NSFG 2006-2010 data, not including births in year earlier than year respondents came to United States.'
  )
```

Similarly to the other data sets, the estimates summarized in Table 12 are very close to the published estimates in Table 11, and inclusion of some births that occurred outside the United States in calculating the estimates of Table 12 likely accounts for the differences.


## During 1997-2001, Based on 2002 (Cycle 6) Data

```{r table13, echo=FALSE, fig.cap='**Table 13:** A table taken from Chandra, et al (2005) containing estimates of number of births in the United States during 1997-2001 based on NSFG 2002 (Cycle 6) data.'}
knitr::include_graphics(file.path('img', '2002_births_table.png'))
```

```{r repeated-2002}
preg_2002_data <- load_nsfg_data(2002, 'Preg')

preg_2002_data$Births <- as.integer(preg_2002_data$OUTCOME == 1)

preg_2002_data$YearEnd <- floor(preg_2002_data$DATEND / 12) + 1900

preg_2002_data$BeforeInUs <- (
  preg_2002_data$YearEnd < preg_2002_data$YRSTRUS
)

preg_2002_data$HISPRACE <- factor(
  preg_2002_data$HISPRACE,
  labels = c(
    'Hispanic',
    'Non-Hispanic White',
    'Non-Hispanic Black',
    'Non-Hispanic Other'
  )
)

preg_2002_data$MarriedAtBirth <- factor(
  ifelse(preg_2002_data$FMAROUT5 == 1, 'Married', 'Unmarried')
)

preg_2002_data$AgeAtDelivery <- cut(
  preg_2002_data$AGEPREG,
  c(0, 2000, 2500, 3000, 4500),
  right = FALSE,
  labels = c(
    'UNDER 20 YEARS',
    '20-24 YEARS',
    '25-29 YEARS',
    '30-44 YEARS'
  )
)

preg_2002_data$BirthOrder <- factor(
  ifelse(preg_2002_data$BIRTHORD >= 3, 3, preg_2002_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

preg_2002_data %>%
  as_survey(
    strata = SEST,
    ids = SECU_P,
    weights = FINALWGT,
    nest = TRUE
  ) %>%
  filter(
    YearEnd >= 1997,
    YearEnd <= 2001,
    is.na(BeforeInUs) | !BeforeInUs
  ) %>%
  generate_birth_estimates_table(
    origin_var = 'HISPRACE', year_end_var = 'YearEnd'
  ) %>%
  knitr::kable(
    align = 'llrr',
    caption = '**Table 14:** Number of births in thousands during 1997-2001 estimated from NSFG 2002 (Cycle 6) data, not including births in year earlier than year respondents came to United States.'
  )
```

Similarly to the other data sets, the estimates summarized in Table 14 are very close to the published estimates in Table 13, and inclusion of some births that occurred outside the United States in calculating the estimates of Table 14 likely accounts for the differences.


## Citations

Chandra A, Martinez GM, Mosher WD, Abma JC, Jones J. Fertility, family planning, and reproductive health of U.S. women: Data from the 2002 National Survey of Family Growth. National Center for Health Statistics. Vital Health Stat 23(25). 2005.

Martinez GM, Daniels K, Chandra A. Fertility of men and women aged 15–44 years in the United States: National Survey of Family Growth, 2006–2010. National health statistics reports; no. 51. Hyattsville, MD: National Center for Health Statistics. 2012.


## Remaining to do

* Repeat with Cycle 5 (1995) data
* Repeat with Cycle 4 (1988) data
* Repeat with Cycle 3 (1982) data
* Repeat with Cycle 2 (1976) data
* Repeat with Cycle 1 (1973) data