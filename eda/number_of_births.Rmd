---
title: "Number of Births"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(dplyr)
library(here)
library(srvyr)
library(survey)

here::i_am(file.path('eda', 'number_of_births.Rmd'))

knitr::opts_chunk$set(
  echo = TRUE,
  cache = FALSE
)
```

## During 2012-2016, Based on 2017-2019

[Appendix 2 to the User Guide for the 2017-2019 NSFG](https://www.cdc.gov/nchs/nsfg/nsfg_2017_2019_puf.htm) contains point estimates and confidence intervals of the number of live births during 2012-2016 in the United States, based on the 2017-2019 NSFG. These estimates are in turn compared with births registered through the National Vital Statistics System to verify their accuracy. See Table 1.

In order to validate the NSFG data are being used correctly with the `survey` package viz a viz weights, pseudo-strata, and pseudo-clusters, and in order to motivate familiarization with the NSFG data set, these point estimates and these confidence intervals are replicated here.

```{r table1, echo=FALSE, fig.cap='**Table 1:** A table taken from page 2 of the Appendix 2 to the User Guide for the 2017-2019 NSFG.'}
knitr::include_graphics(file.path('img', '2017-2019_App2_table.png'))
```

```{r load-data, message=FALSE, cache=TRUE}
source(here('src', 'load_data.R'))
fem_preg_data <- load_nsfg_data('2017_2019', 'FemPregData')
```


### Variables for Filtering

The estimates in Table 1 can be calculated from data in the female pregnancy file (`2017_2019_FemPregData.dat`). The filtering necessary for these estimates appear to be based on variables for pregnancy outcome (`OUTCOME`), year pregnancy ended (`DATEND`), whether respondent was born outside of the United States (`BRNOUT`), and the year the respondent came to the United States (`YRSTRUS`).

The `OUTCOME` and `DATEND` are recoded variables, whereas `BRNOUT` is a raw variable.

```{r check-outcome}
count(
  data.frame(Outcome = factor(
    fem_preg_data$OUTCOME,
    labels = c(
      'LIVE BIRTH',
      'INDUCED ABORTION',
      'STILLBIRTH',
      'MISCARRIAGE',
      'ECTOPIC PREGNANCY',
      'CURRENT PREGNANCY'
    )
  )),
  Outcome
)
```

The counts of each level of the `OUTCOME` variable match the counts reported in the codebook.

```{r check-datend}
count(
  fem_preg_data,
  INAPPLICABLE = is.na(DATEND)
)
```

The are 193 observations for which `DATEND` is inapplicable and 10,022 otherwise, which matches what is reported in the codebook.

```{r check-brnout}
count(
  data.frame(BRNOUT = factor(
    fem_preg_data$BRNOUT,
    labels = c('Yes', 'No', 'Refused', "Don't Know")
  )),
  BRNOUT
)
```

The counts of each level of the `BRNOUT` variable matches what is in the codebook.

The `YRSTRUS` variable does not appear to be documented in the 2017-2019 NSFG documentation. The last time it appears in the Female Pregnancy File Codebook is in the 2015-2017 NSFG documentation, which references Appendix 7 of the User Guide. However, only the `STRUS_M`, `STRUS_F`, and `CMSTRUS` variables are discussed in Appendix 7 in the 2015-2017 NSFG documentation. These variables contain the month and year that a respondent came to United States, if the respondent is born elsewhere, and are not released in the public use data files due to disclosure risk.

The Appendix 7 in the 2013-2015 NSFG documentation does discuss the `YRSTRUS` variable, stating that it contains a calculated value indicating only the year the respondent came to stay in the United States. However, as seen below, there are only the values 1, 2, 3, or 4 contained in the `YRSTRUS` data for the 2017-2019 NSFG data set, in addition to values customarily used to encode for "refused" and "don't know" responses and to encode for non-applicability.

```{r check-yrstrus}
fem_preg_data %>%
  group_by(YRSTRUS) %>%
  count()
```

Fortunately, even though the 2017-2019 encoding of the `YRSTRUS` variable is not documented anywhere, the SAS program statement for the female pregnancy file contains a values definition for the variable.

```{sas, eval=FALSE}
  value YRSTRUS
     1 = '1968-1989'  
     2 = '1990-1999'  
     3 = '2000-2009'  
     4 = '2010-2019'  
     98 = 'Refused'  
     99 = 'Don''t know' ;
```

```{r check-yrstrus2}
count(
  data.frame(YRSTRUS = factor(
    fem_preg_data$YRSTRUS,
    labels = c(
      '1968-1989',
      '1990-1999',
      '2000-2009',
      '2010-2019',
      'Refused',
      "Don't know"
    )
  )),
  YRSTRUS
)
```

It appears as though the `YRSTRUS` in the 2017-2019 public use files has been modified even more than in previous iterations of the public use files. Because the estimates of Table 1 are of live births in the United States from 2012-2016, the only possible use of the `YRSTRUS` variable for calculating Table 1 estimates is to filter out observations with value `4` of the `YRSTRUS`, which consists of 355 observations. However, this also filters out some observations of births that did occur in the United States. Therefore, the estimates are calculated both with and without these observations, to verify if such filtering changes the estimates substantially.


### Estimates Using Unwrapped `survey` Package

```{r check-strat-and-id}
fem_preg_data %>%
  group_by(SEST, SECU) %>%
  count()
```

The pseudo-stratum and pseudo-PSU identifiers appear to be nested.

```{r specify-survey-design}
fem_preg_data$OUTCOME <- factor(
  fem_preg_data$OUTCOME,
  labels = c(
    'LIVE BIRTH',
    'INDUCED ABORTION',
    'STILLBIRTH',
    'MISCARRIAGE',
    'ECTOPIC PREGNANCY',
    'CURRENT PREGNANCY'
  )
)

fem_preg_data$YRSTRUS <- factor(
  fem_preg_data$YRSTRUS,
  labels = c(
    '1968-1989',
    '1990-1999',
    '2000-2009',
    '2010-2019',
    'Refused',
    "Don't know"
  )
)

fem_preg_data$Births <- ifelse(
  fem_preg_data$OUTCOME == 'LIVE BIRTH',
  1,
  0
)

fem_preg_data$HISPRACE2 <- factor(
  fem_preg_data$HISPRACE2,
  labels = c(
    'Hispanic',
    'Non-Hispanic White, Single Race',
    'Non-Hispanic Black, Single Race',
    'Non-Hispanic Other or Multiple Race'
  )
)

fem_preg_data$FMAROUT5 <- factor(
  fem_preg_data$FMAROUT5,
  labels = c(
    'MARRIED',
    'DIVORCED',
    'WIDOWED',
    'SEPARATED',
    'NEVER MARRIED'
  )
)

fem_preg_data$MarriedAtBirth <- factor(
  ifelse(fem_preg_data$FMAROUT5 == 'MARRIED', 'Married', 'Unmarried')
)

fem_preg_data$BirthOrder <- factor(
  ifelse(fem_preg_data$BIRTHORD >= 3, 3, fem_preg_data$BIRTHORD),
  labels = c(
    '1st',
    '2nd',
    '3rd or higher'
  )
)

fem_preg_svy <- svydesign(
  data = fem_preg_data,
  strat = ~SEST,
  id = ~SECU,
  weight = ~WGT2017_2019,
  nest = TRUE
)

fem_preg_svy
```


#### Total

```{r, total-births}
live_births_2012_2016_svy <- subset(
  fem_preg_svy,
  DATEND >= 2012 & DATEND <= 2016
)

live_births_us_2012_2016_svy <- subset(
  live_births_2012_2016_svy,
  is.na(YRSTRUS) | YRSTRUS != '2010-2019'
)

num_births_stat <- svytotal(~Births, live_births_2012_2016_svy)

num_births_us_stat <- svytotal(~Births, live_births_us_2012_2016_svy)

num_births_stat

num_births_us_stat
```

As expected, the estimate without attempting to filter births occurring outside the United States is too high, the estimate that filters out births for respondents who came to the United States in the 2010-2019 time period is too low, since such filtering also filters some births occuring in the United States.

```{r, total-birth-CIs}
knitr::kable(
  format(
    round(
      cbind(
        coef(num_births_stat),
        confint(num_births_stat, df = degf(fem_preg_svy))
      ) / 1000
    ),
    big.mark = ','
  ),
  caption = '**Table 2:** Estimates of live births (in thousounds) during 2012-2016 without Filtering on `YRSTRUS`.'
)

knitr::kable(
  format(
    round(
      cbind(
        coef(num_births_us_stat),
        confint(num_births_us_stat, df = degf(fem_preg_svy))
      ) / 1000
    ),
    big.mark = ','
  ),
  caption = '**Table 3:** Estimates of live births (in thousands) during 2012-2016 with Filtering on `YRSTRUS != 4`.'
)
```

The confidence intervals seem reasonable compared to the confidence interval for total births in Table 1. The lower bound of the confidence interval without filtering on `YRSTRUS` in Table 2 is very close to the lower bound in Table 1, and the upper bound of the confidence interval with filtering on `YRSTRUS` in Table 3 is very close to the upper bound in Table 1.


#### By Year of Delivery

```{r by-year-of-delivery}
svyby(
  ~Births,
  ~DATEND,
  svytotal,
  design = live_births_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~DATEND,
  svytotal,
  design = live_births_us_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

The estimated number of births for each year without any attempt to eliminate births outside the United States are overestimates compared with Table 1, while filtering births to those respondents who came to the United States during 2010-2019 results in underestimates compared with Table 1, as expected.


#### By Hispanic Origin and Racial Classification

```{r by-hispanic-origin-and-racial-classification}
svyby(
  ~Births,
  ~HISPRACE2,
  svytotal,
  design = live_births_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~HISPRACE2,
  svytotal,
  design = live_births_us_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

Estimated number of births in the subpopulation categorized "Hispanic or Latina" is an overestimate when compared with Table 1 without any filtering for births outside the United States, and an underestimate when filtering by respondents who came to the United States during 2010-2019. Unlike other subpopulations, both subpopulations under "Not Hispanic" have underestimates for number of births compared with Table 1, regardless of whether or not filtering based on time respondent came to United States is done.


#### By Martial Status at Birth

```{r by-martial-status-at-birth}
svyby(
  ~Births,
  ~MarriedAtBirth,
  svytotal,
  design = live_births_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~MarriedAtBirth,
  svytotal,
  design = live_births_us_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)
```

The estimates for number of births for the married and unmarried subpopulations bracket the estimates in Table 1 as described in other sections.


#### By Birth Order

```{r by-birth-order}
svyby(
  ~Births,
  ~BirthOrder,
  svytotal,
  design = live_births_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

svyby(
  ~Births,
  ~BirthOrder,
  svytotal,
  design = live_births_us_2012_2016_svy,
  keep.names = FALSE,
  vartype = 'ci'
)

```

The estimates for number of births for subpopulations by birth order bracket the estimates in Table 1 as described in other sections.


### Estimated Using `srvyr` Package

The `srvyr` package wraps the `survey` package providing a tidyverse-like interface. In this section, the estimates calculated above are replicated using the `srvyr` package.

```{r srvyr}
generate_birth_estimates_table <- function(srvyr_tbl) {
  format_births <- function(raw) {
    format(
      round(raw / 1000),
      big.mark = ',',
      width = 5
    )
  }

  subpopulation_helper <- function(varname, label) {
    srvyr_tbl %>%
      group_by(!!sym(varname)) %>%
      summarize(
        Births = survey_total(Births, vartype = 'ci')
      ) %>%
      rename(Subpopulation = !!sym(varname)) %>%
      mutate(across(starts_with('Births'), format_births)) %>%
      transmute(
        Subpopulation = Subpopulation,
        `Point Estimate` = Births,
        `95% Confidence Interval` = paste(Births_low, Births_upp, sep = ' - ')
      ) %>%
      mutate(Label = label, .before = 1)
  }

  total_row <- srvyr_tbl %>%
    summarize(
      Births = survey_total(Births, vartype = 'ci')
    ) %>%
    mutate(across(starts_with('Births'), format_births)) %>%
    transmute(
      `Point Estimate` = Births,
      `95% Confidence Interval` = paste(Births_low, Births_upp, sep = ' - ')
    ) %>%
    mutate(
      Label = 'Total',
      Subpopulation = NA,
      .before = 1
    )

  rbind(
    total_row,
    subpopulation_helper('DATEND', 'By year of delivery'),
    subpopulation_helper('HISPRACE2', 'By origin and race'),
    subpopulation_helper('MarriedAtBirth', 'By marital status at birth'),
    subpopulation_helper('BirthOrder', 'By birth order') %>%
      filter(!is.na(Subpopulation))
  )
}

live_births_2012_2016_srvyr <- fem_preg_data %>%
  as_survey(
    strata = SEST,
    ids = SECU,
    weights = WGT2017_2019,
    nest = TRUE
  ) %>%
  filter(
    DATEND >= 2012 & DATEND <= 2016
  )

knitr::kable(
  generate_birth_estimates_table(live_births_2012_2016_srvyr),
  align = 'llrr',
  caption = '**Table 4:** Number of births in 2012-2016 estimated from NSFG 2017-2019 data, including some births that occurred outside of United States.'
)

live_births_us_2012_2016_srvyr <- live_births_2012_2016_srvyr %>%
  filter(
    is.na(YRSTRUS) | YRSTRUS != '2010-2019'
  )

knitr::kable(
  generate_birth_estimates_table(live_births_us_2012_2016_srvyr),
  align = 'llrr',
  caption = '**Table 5:** Number of births in 2012-2016 estimated from NSFG 2017-2019 data, not including births of respondents who came to United States during 2010-2019.'
)
```

Using `tidyverse` processing facilitated by `srvyr`, it is relatively easy to collect the statistics into a single table.


## Remaining to do

* Repeat with 2015-2017 data