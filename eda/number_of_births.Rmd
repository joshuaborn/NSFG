---
title: "Number of Births"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
library(dplyr)
library(here)
library(survey)

here::i_am(file.path('eda', 'number_of_births.Rmd'))

knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE
)
```

## During 2012-2016, Based on 2017-2019

[Appendix 2 to the User Guide for the 2017-2019 NSFG](https://www.cdc.gov/nchs/nsfg/nsfg_2017_2019_puf.htm) contains point estimates and confidence intervals of the number of live births during 2012-2016 in the United States, based on the 2017-2019 NSFG. These estimates are in turn compared with births registered through the National Vital Statistics System to verify their accuracy. See Table 1.

In order to validate the NSFG data are being used correctly with the `survey` package viz a viz weights, pseudo-strata, and pseudo-clusters, and in order to motivate familiarization with the NSFG data set, these point estimates and these confidence intervals are replicated here.

```{r table1, echo=FALSE, fig.cap='**Table 1:** A table taken from page 2 of the Appendix 2 to the User Guide for the 2017-2019 NSFG.'}
knitr::include_graphics(file.path('img', '2017-2019_App2_table.png'))
```

```{r load-data, message=FALSE, echo=FALSE}
source(here('src', 'load_data.R'))
```


### Relevant Variables

The estimates in Table 1 can be calculated from data in the female pregnancy file (`2017_2019_FemPregData.dat`). The filtering necessary for these estimates appear to be based on variables for pregnancy outcome (`OUTCOME`), year pregnancy ended (`DATEND`), whether respondent was born outside of the United States (`BRNOUT`), and the year the respondent came to the United States (`YRSTRUS`).

The `OUTCOME` and `DATEND` are recoded variables, whereas `BRNOUT` is a raw variable.

```{r check-outcome}
count(
  data.frame(Outcome = factor(
    fem_preg_data$OUTCOME,
    labels = c(
      'LIVE BIRTH',
      'INDUCED ABORTION',
      'STILLBIRTH',
      'MISCARRIAGE',
      'ECTOPIC PREGNANCY',
      'CURRENT PREGNANCY'
    )
  )),
  Outcome
)
```

The counts of each level of the `OUTCOME` variable match the counts reported in the codebook.

```{r check-datend}
count(
  fem_preg_data,
  INAPPLICABLE = is.na(DATEND)
)
```

The are 193 observations for which `DATEND` is inapplicable and 10,022 otherwise, which matches what is reported in the codebook.

```{r check-brnout}
count(
  data.frame(BRNOUT = factor(
    fem_preg_data$BRNOUT,
    labels = c('Yes', 'No', 'Refused', "Don't Know")
  )),
  BRNOUT
)
```

The counts of each level of the `BRNOUT` variable matches what is in the codebook.

The `YRSTRUS` variable does not appear to be documented in the 2017-2019 NSFG documentation. The last time it appears in the Female Pregnancy File Codebook is in the 2015-2017 NSFG documentation, which references Appendix 7 of the User Guide. However, only the `STRUS_M`, `STRUS_F`, and `CMSTRUS` variables are discussed in Appendix 7 in the 2015-2017 NSFG documentation. These variables contain the month and year that a respondent came to United States, if the respondent is born elsewhere, and are not released in the public use data files due to disclosure risk.

The Appendix 7 in the 2013-2015 NSFG documentation does discuss the `YRSTRUS` variable, stating that it contains a calculated value indicating only the year the respondent came to stay in the United States. However, as seen below, there are only the values 1, 2, 3, or 4 contained in the `YRSTRUS` data for the 2017-2019 NSFG data set, in addition to values customarily used to encode for "refused" and "don't know" responses and to encode for non-applicability.

```{r check-yrstrus}
fem_preg_data %>%
  group_by(YRSTRUS) %>%
  count()
```

Fortunately, even though the 2017-2019 encoding of the `YRSTRUS` variable is not documented anywhere, the SAS program statement for the female pregnancy file contains a values definition for the variable.

```{sas, eval=FALSE}
  value YRSTRUS
     1 = '1968-1989'  
     2 = '1990-1999'  
     3 = '2000-2009'  
     4 = '2010-2019'  
     98 = 'Refused'  
     99 = 'Don''t know' ;
```

```{r check-yrstrus2}
count(
  data.frame(YRSTRUS = factor(
    fem_preg_data$YRSTRUS,
    labels = c(
      '1968-1989',
      '1990-1999',
      '2000-2009',
      '2010-2019',
      'Refused',
      "Don't know"
    )
  )),
  YRSTRUS
)
```

It appears as though the `YRSTRUS` in the 2017-2019 public use files has been modified even more than in previous iterations of the public use files. Because the estimates of Table 1 are of live births in the United States from 2012-2016, the only possible use of the `YRSTRUS` variable for calculating Table 1 estimates is to filter out observations with value `4` of the `YRSTRUS`, which consists of 355 observations. However, this also filters out some observations of births that did occur in the United States. Therefore, the estimates are calculated both with and without these observations, to verify if such filtering changes the estimates substantially.


### Estimates Using Unwrapped `survey` Package

```{r check-strat-and-id}
fem_preg_data %>%
  group_by(SEST, SECU) %>%
  count()
```

The pseudo-stratum and pseudo-PSU identifiers appear to be nested.

```{r specify-survey-design}
fem_preg_data$OUTCOME <- factor(
  fem_preg_data$OUTCOME,
  labels = c(
    'LIVE BIRTH',
    'INDUCED ABORTION',
    'STILLBIRTH',
    'MISCARRIAGE',
    'ECTOPIC PREGNANCY',
    'CURRENT PREGNANCY'
  )
)

fem_preg_data$YRSTRUS <- factor(
  fem_preg_data$YRSTRUS,
  labels = c(
    '1968-1989',
    '1990-1999',
    '2000-2009',
    '2010-2019',
    'Refused',
    "Don't know"
  )
)

fem_preg_data$Births <- ifelse(
  fem_preg_data$OUTCOME == 'LIVE BIRTH',
  1,
  0
)

fem_preg_svy <- svydesign(
  data = fem_preg_data,
  strat = ~SEST,
  id = ~SECU,
  weight = ~WGT2017_2019,
  nest = TRUE
)

fem_preg_svy
```

```{r, total-births}
live_births_2012_2016_svy <- subset(
  fem_preg_svy,
  DATEND >= 2012 & DATEND <= 2016
)

live_births_us_2012_2016_svy <- subset(
  live_births_2012_2016_svy,
  is.na(YRSTRUS) | YRSTRUS != '2010-2019'
)

num_births_stat <- svytotal(~Births, live_births_2012_2016_svy)

num_births_us_stat <- svytotal(~Births, live_births_us_2012_2016_svy)

num_births_stat

num_births_us_stat
```

As expected, the estimate without attempting to filter births occurring outside the United States is too high, the estimate that filters out births for respondents who came to the United States in the 2010-2019 time period is too low, since such filtering also filters some births occuring in the United States.

While using base R functions the `survey` package functions is straightfoward, the syntax becomes unwieldy when trying to handle the output, for instance, to display confidence intervals.

```{r, total-birth-CIs}
CI <- function(statistic, alpha = 0.05) {
  stat_name <- names(coef(statistic))
  raw_stat <- unname(coef(statistic))
  raw_se <- unname(SE(statistic))[1, 1]
  summary.df <- cbind(
    raw_stat,
    raw_stat - qnorm(1-alpha) * raw_se,
    raw_stat + qnorm(1-alpha) * raw_se
  )
  rownames(summary.df) <- stat_name
  CI_string <- paste((1 - alpha) * 100, '% CI', sep = '')
  colnames(summary.df) <- c(
    'Estimate',
    paste(CI_string, 'Low'),
    paste(CI_string, 'High')
  )
  summary.df
}

knitr::kable(
  format(
    round(CI(num_births_stat) / 1000),
    big.mark = ','
  ),
  caption = '**Table 2:** Estimates of live births (in thousounds) during 2012-2016 without Filtering on `YRSTRUS`.'
)

knitr::kable(
  format(
    round(CI(num_births_us_stat) / 1000),
    big.mark = ','
  ),
  caption = '**Table 3:** Estimates of live births (in thousands) during 2012-2016 with Filtering on `YRSTRUS != 4`.'
)
```

The confidence intervals seem reasonable compared to the confidence interval for total births in Table 1. The lower bound of the confidence interval with filtering on `YRSTRUS` in Table 3 is approximately the lower bound in Table 1, and the upper bound of the confidence interval without filtering on `YRSTRUS` in Table 2 is very close to the upper bound in Table 1.


## Remaining to do

* Rest of Table 1
* Same thing, but with `srvyr`
* Repeat with 2015-2017 data