---
title: "Use and Nonuse of Contraception in the United States Reported in the 2017-2019 National Survey of Family Growth"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

source(here('R/import.R'))

i_am('reports/contraceptive_use_and_nonuse_in_the_united_states_2017-2019.Rmd')

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r helpers}
has_level <- function(x, ids) {
  !is.na(x) & is.element(as.integer(x), ids)
}

get_raw_import_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    fem1719
  } else {
    male1719
  }
}

get_dt_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    setDT(fem1719dt)
  } else {
    setDT(male1719dt)
  }
}

get_idxs <- function(format, skip = NULL, sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  idxs <- raw_import$Formats[format_name == format, factor_value]
  if (!is.null(skip)) {
    idxs[!is.element(idxs, skip)]
  } else {
    idxs
  }
}

set_mention_count_variable <- function(dt, prefix) {
  if (paste(prefix, 'count', sep = '_') %in% colnames(dt)) {
    dt[
      ,
      (paste(prefix, 'count', sep = '_')) := NULL
    ]
  }
  dt[
    ,
    (paste(prefix, 'count', sep = '_')) := rowSums(.SD),
    .SDcols = patterns(paste('^', prefix, sep = ''))
  ]
}

set_mentions_to_booleans <- function(
  out_prefix,
  in_prefix,
  in_series,
  format,
  skip = NULL,
  sex = 'fem'
) {
  dt <- get_dt_for_sex(sex)
  in_vars <- paste(in_prefix, in_series, sep = '')

  for (x in get_idxs(format, skip, sex)) {
    set(
      dt,
      j = paste(out_prefix, x, sep = ''),
      value = get_raw_import_for_sex(sex)$Data[
        ,
        lapply(.SD, \(col) has_level(col, x)),
        .SDcols = in_vars
      ] |> apply(1, any)
    )
  }

  set_mention_count_variable(dt, out_prefix)
}

set_variables_as_factors <- function(variables, sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  dt <- get_dt_for_sex(sex)

  for (x in seq(length(variables))) {
    variable_name <- names(variables)[x]
    format_name <- variables[x]
    values <- factorize(
      raw_import$Data[, get(variable_name)],
      format_name,
      raw_import$Formats
    )

    dt[, (variable_name) := ..values]
  }
}

estimate_totals_and_percentages <- function(f, svy) {
  totals <- svytotal(f, svy)
  totals_ci <- as.data.frame(confint(totals, df = degf(svy)))
  names(totals_ci) <- c('total_CI_low', 'total_CI_high')
  percentages <- svymean(f, svy)
  percentages_ci <- as.data.frame(confint(percentages, df = degf(svy)))
  names(percentages_ci) <- c('percentage_CI_low', 'percentage_CI_high')
  level_prefix <- as.character(f)
  level_prefix <- level_prefix[seq(2, length(level_prefix))]

  cbind(
    data.table(
      description = sub(level_prefix, '', names(totals), fixed = TRUE),
      total = as.vector(totals)
    ),
    totals_ci,
    data.table(
      percentage = as.vector(percentages)
    ),
    percentages_ci
  )
}

rounded_estimates <- function(dt) {
  cbind(
    dt[
      ,
      .SD,
      .SDcols = patterns('^[^(total)|(percentage)]')
    ],
    dt[
      ,
      lapply(.SD, \(col) round(col / 10^6, 3)),
      .SDcols = patterns('^total')
    ],
    dt[
      ,
      lapply(.SD, \(col) round(col, 3) * 100),
      .SDcols = patterns('^percentage')
    ]
  )
}

string_estimates <- function(dt) {
  dt[,
    .(
      description,
      total = sprintf("%.3fM", total),
      total_CI = sprintf(
        "(%.3fM, %.3fM)",
        total_CI_low,
        total_CI_high
      ),
      percentage = sprintf("%0.1f%%", percentage),
      percentage_CI = sprintf(
        "(%0.1f%%, %0.1f%%)",
        percentage_CI_low,
        percentage_CI_high
      )
    )
  ]
}

pretty_estimates <- function(dt) {
  dt |>
    rounded_estimates() |>
    string_estimates()
}

svy <- function(dt) {
  svydesign(
    ids = ~SECU,
    strata = ~SEST,
    data = dt,
    nest = TRUE,
    weights = ~WGT2017_2019
  )
}


estimate_mentions <- function(
  svy,
  prefix,
  series,
  format,
  skip = NULL,
  sex = 'fem'
) {
  raw_import <- get_raw_import_for_sex(sex)
  dt <- get_dt_for_sex(sex)

  estimates <- rbindlist(lapply(
    get_idxs(format, skip, sex),
    function(x) {
      row <- estimate_totals_and_percentages(
        as.formula(paste('~', prefix, x, sep = '')),
        svy
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, format, raw_import$Formats)
  ]

  estimates
}
```

```{r load-data}
fem1719 <- load_NSFG_data('2017_2019', 'FemResp')
male1719 <- load_NSFG_data('2017_2019', 'Male')
```

```{r usedlast3m-meth-fem, dependson=c('helpers', 'load-data')}
fem1719dt <- copy(fem1719$Data[, .(
  CASEID,
  SECU,
  SEST,
  WGT2017_2019
)])

set_mentions_to_booleans(
  out_prefix = 'usedlast3m_meth',
  in_prefix = 'METH3M',
  in_series = 1:3,
  format = 'METH3MF',
  skip = 20:21
)

set_variables_as_factors(
  variables = c(
    P1YRELP = 'P1YRELP',
    PSURGSTR = 'Y1N5C',
    SEX3MO = 'Y1N2RECF',
    TUBS = 'Y1N5C'
  )
)

# set any respondents who are sexually active in past 3 months and whose last intercourse was with husband or cohabitating partner who has an active vasectomy as using vasectomy as a contraceptive method
fem1719dt[,
  usedlast3m_meth3 := fifelse(
    SEX3MO == 'YES' & PSURGSTR == 'YES' & (
      P1YRELP == 'Current husband or (current husband from whom she is separated)' |
      P1YRELP == 'Current cohabiting partner'
    ),
    TRUE,
    usedlast3m_meth3
  )
]

# set any respondents with current tubal ligations who are sexually active as currently using tubal ligation as a contraceptive method
fem1719dt[,
  usedlast3m_meth4 := fifelse(
    SEX3MO == 'YES' & TUBS == 'YES',
    TRUE,
    usedlast3m_meth4
  )
]

# reset count of methods used at last intercourse to include overrides of tubal ligations and vasectomies
set_mention_count_variable(fem1719dt, 'usedlast3m_meth')
```

```{r usedlast3m-meth-male, dependson=c('helpers', 'load-data')}
male1719dt <- copy(male1719$Data[, .(
  CASEID,
  SECU,
  SEST,
  WGT2017_2019
)])

set_mentions_to_booleans(
  sex = 'male',
  out_prefix = 'usedlast3m_meth',
  in_prefix = 'METH3M',
  in_series = 1:4,
  format = 'METH3MF',
  skip = 95:96
)

set_variables_as_factors(
  sex = 'male',
  variables = c(
    P1COHABIT = 'Y1N5RDF',
    P1CURRWIFE = 'Y1N5RDF',
    PSURGSTR = 'N0Y1CF',
    RSURGSTR = 'N0Y1RDF',
    SEX3MO = 'SEX3MO'
  )
)

# count any respondents who are sexually active and who have an active vasectomy as using vasectomy as a contraceptive method
male1719dt[,
  usedlast3m_meth3 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
    TRUE,
    usedlast3m_meth3
  )
]

# count any respondents who are sexually active and who are married or cohabitating and whose last intercourse was with wife or cohabitating partner who has active tubal ligation
male1719dt[,
  usedlast3m_meth5 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' &
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') &
      PSURGSTR == 'YES',
    TRUE,
    usedlast3m_meth5
  )
]

# reset count of methods used at last intercourse to include overrides of tubal ligations and vasectomies
set_mention_count_variable(male1719dt, 'usedlast3m_meth')
```


# Persons in Populations

Description: Persons aged 15-49 living in households in the United States as estimated by the NSFG

## Females

```{r, dependson='usedlast3m-meth-fem'}
fem1719dt[, person := 1]

(estimate_totals_and_percentages(
  ~person,
  svy(fem1719dt)
) |> pretty_estimates())[
  , .(total, total_CI)
] |> kable()
```

## Males

```{r, dependson='usedlast3m-meth-male'}
male1719dt[, person := 1]

(estimate_totals_and_percentages(
  ~person,
  svy(male1719dt)
) |> pretty_estimates())[
  , .(total, total_CI)
] |> kable()
```


# Currently Using Contraception

Domain: Persons aged 15-49 living in households in the United States

Description: By whether had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

## Females

```{r, dependson='usedlast3m-meth-fem'}
fem1719dt[,
  usedlast3m := factor(fifelse(
    usedlast3m_meth_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]

estimate_totals_and_percentages(
  ~usedlast3m,
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

## Males

```{r, dependson='usedlast3m-meth-male'}
male1719dt[,
  usedlast3m := factor(fifelse(
    usedlast3m_meth_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]

estimate_totals_and_percentages(
  ~usedlast3m,
  svy(male1719dt)
) |> pretty_estimates() |> kable()
```


# Method(s) at Last Intercourse

## Number of Methods

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By number of methods used at last intercourse

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_meth_count),
  subset(
    svy(fem1719dt),
    usedlast3m_meth_count > 0
  )
) |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_meth_count),
  subset(
    svy(male1719dt),
    usedlast3m_meth_count > 0
  )
) |> pretty_estimates() |> kable()
```


## Method(s) Used at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth_count > 0
  ),
  prefix = 'usedlast3m_meth',
  series = 1:3,
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth_count > 0
  ),
  prefix = 'usedlast3m_meth',
  series = 1:4,
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Method Used Exclusively at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used **one and only one** method of contraception during last intercourse

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth_count == 1
  ),
  prefix = 'usedlast3m_meth',
  series = 1:3,
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth_count == 1
  ),
  prefix = 'usedlast3m_meth',
  series = 1:4,
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Proportion of Method Users Who Also Used Other Method(s)

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used each specific method of contraception during last intercourse

Description: Proportion who also used other method(s)

### Females

```{r, dependson='usedlast3m-meth-fem'}
(function() {
  estimates <- rbindlist(lapply(
    get_idxs('METH3MF', 20:21, 'fem'),
    function(x) {
      row <- estimate_totals_and_percentages(
        ~I(usedlast3m_meth_count > 1),
        subset(
          svy(fem1719dt),
          fem1719dt[, get(sprintf('usedlast3m_meth%d', x))]
        )
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, 'METH3MF', fem1719$Formats)
  ]

  estimates
})()[!is.nan(total_CI_low)][order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
(function() {
  estimates <- rbindlist(lapply(
    get_idxs('METH3MF', 95:96, 'male'),
    function(x) {
      row <- estimate_totals_and_percentages(
        ~I(usedlast3m_meth_count > 1),
        subset(
          svy(male1719dt),
          male1719dt[, get(sprintf('usedlast3m_meth%d', x))]
        )
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, 'METH3MF', male1719$Formats)
  ]

  estimates
})()[order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Calendar Method

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a calendar method during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth8
  ),
  prefix = 'usedlast3m_meth',
  series = 1:3,
  skip = c(8, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth9
  ),
  prefix = 'usedlast3m_meth',
  series = 1:4,
  skip = c(9, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Withdrawal

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used withdrawal during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth5
  ),
  prefix = 'usedlast3m_meth',
  series = 1:3,
  skip = c(5, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth2
  ),
  prefix = 'usedlast3m_meth',
  series = 1:4,
  skip = c(2, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Condoms

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used condoms during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth2
  ),
  prefix = 'usedlast3m_meth',
  series = 1:3,
  skip = c(2, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth1
  ),
  prefix = 'usedlast3m_meth',
  series = 1:4,
  skip = c(1, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Pill

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used the pill during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

### Females

```{r, dependson='usedlast3m-meth-fem'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth1
  ),
  prefix = 'usedlast3m_meth',
  series = 1:3,
  skip = c(1, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

### Males

```{r, dependson='usedlast3m-meth-male'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth4
  ),
  prefix = 'usedlast3m_meth',
  series = 1:4,
  skip = c(4, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```



* Not currently using contraception, overview by category
* Not sexually active currently
    * Never
        * Reason for never
    * Same-sex attractedness
* Physically infertile category (females)
    * By reason in domain
    * By reason generally
    * Partner infertile generally
* Why not using contraception (females)
    * By reason(s)
    * By main or exclusive reason
    * Reasons(s) for those who believe themselves infertile to think themselves infertile
* Overall contraception rate
    * Males who don't know
* Method(s) used at last intercourse
* Past 12 months
    * Number of methods
    * By method(s) used
    * By method, among those using only one method
* Consistency
    * Did not use at last intercourse, but used at least one method in past 12 months
    * Did not use at last intercourse, but ever used contraception (females)
    * Frequency of any method use in past 12 months
    * Frequency of condom use in past 12 months
    * Frequency of condom use in past 12 months, among exclusive condom users
    * Frequency of condom use in past 4 weeks (females)
    * Number of missed pills in past 4 weeks (females)
* Ever (females)
    * By method(s)
    * By method(s) among those who have had intercourse with opposite sex
    * Ever discontinued due to dissatisfaction
    * Reason for dissatisfaction with pill
    * Reason for dissatisfaction with condoms
    * Reason for dissatisfaction with IUDs
* Use for reasons other than contraception
    * Condom, pill, IUD, and tubal ligation among females
    * Condom among males



# Things to Do

* Collect estimates into this report
* Style plots and tables for output
* Write text of report
* Review situations in which universes do not match specifications in codebooks and follow up with NSFG administrators
* Compare own report with published reports
* Look into what it takes to publish in an academic journal
* Replicate analysis in SAS
    * Attempt single-factor categorical data analysis, e.g., whether totals of otherwise not using contraception and currently trying to conceive are different
