---
title: "Use and Nonuse of Contraception in the United States Reported in the 2017-2019 National Survey of Family Growth"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

source(here('R/import.R'))

i_am('reports/contraceptive_use_and_nonuse_in_the_united_states_2017-2019.Rmd')

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r helpers}
has_level <- function(x, ids) {
  !is.na(x) & is.element(as.integer(x), ids)
}

get_raw_import_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    fem1719
  } else {
    male1719
  }
}

get_dt_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    setDT(fem1719dt)
  } else {
    setDT(male1719dt)
  }
}

get_idxs <- function(format, skip = NULL, sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  idxs <- raw_import$Formats[format_name == format, factor_value]
  if (!is.null(skip)) {
    idxs[!is.element(idxs, skip)]
  } else {
    idxs
  }
}

set_mention_count_variable <- function(dt, prefix) {
  if (paste(prefix, 'count', sep = '_') %in% colnames(dt)) {
    dt[
      ,
      (paste(prefix, 'count', sep = '_')) := NULL
    ]
  }
  dt[
    ,
    (paste(prefix, 'count', sep = '_')) := rowSums(.SD),
    .SDcols = patterns(paste('^', prefix, sep = ''))
  ]
}

set_mentions_to_booleans <- function(
  out_prefix,
  in_prefix,
  in_series,
  format,
  skip = NULL,
  sex = 'fem'
) {
  dt <- get_dt_for_sex(sex)
  in_vars <- paste(in_prefix, in_series, sep = '')

  for (x in get_idxs(format, skip, sex)) {
    set(
      dt,
      j = paste(out_prefix, x, sep = ''),
      value = get_raw_import_for_sex(sex)$Data[
        ,
        lapply(.SD, \(col) has_level(col, x)),
        .SDcols = in_vars
      ] |> apply(1, any)
    )
  }

  set_mention_count_variable(dt, out_prefix)
}

set_variables_as_factors <- function(variables, sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  dt <- get_dt_for_sex(sex)

  for (x in seq(length(variables))) {
    variable_name <- names(variables)[x]
    format_name <- variables[x]
    values <- factorize(
      raw_import$Data[, get(variable_name)],
      format_name,
      raw_import$Formats
    )

    dt[, (variable_name) := ..values]
  }
}

estimate_totals_and_percentages <- function(f, svy) {
  totals <- svytotal(f, svy)
  totals_ci <- as.data.frame(confint(totals, df = degf(svy)))
  names(totals_ci) <- c('total_CI_low', 'total_CI_high')
  percentages <- svymean(f, svy)
  percentages_ci <- as.data.frame(confint(percentages, df = degf(svy)))
  names(percentages_ci) <- c('percentage_CI_low', 'percentage_CI_high')
  level_prefix <- as.character(f)
  level_prefix <- level_prefix[seq(2, length(level_prefix))]

  cbind(
    data.table(
      description = sub(level_prefix, '', names(totals), fixed = TRUE),
      total = as.vector(totals)
    ),
    totals_ci,
    data.table(
      percentage = as.vector(percentages)
    ),
    percentages_ci
  )
}

rounded_estimates <- function(dt) {
  cbind(
    dt[
      ,
      .SD,
      .SDcols = patterns('^[^(total)|(percentage)]')
    ],
    dt[
      ,
      lapply(.SD, \(col) round(col / 10^6, 3)),
      .SDcols = patterns('^total')
    ],
    dt[
      ,
      lapply(.SD, \(col) round(col, 3) * 100),
      .SDcols = patterns('^percentage')
    ]
  )
}

string_estimates <- function(dt) {
  dt[,
    .(
      description,
      total = sprintf("%.3fM", total),
      total_CI = sprintf(
        "(%.3fM, %.3fM)",
        total_CI_low,
        total_CI_high
      ),
      percentage = sprintf("%0.1f%%", percentage),
      percentage_CI = sprintf(
        "(%0.1f%%, %0.1f%%)",
        percentage_CI_low,
        percentage_CI_high
      )
    )
  ]
}

pretty_estimates <- function(dt) {
  dt |>
    rounded_estimates() |>
    string_estimates()
}

svy <- function(dt) {
  svydesign(
    ids = ~SECU,
    strata = ~SEST,
    data = dt,
    nest = TRUE,
    weights = ~WGT2017_2019
  )
}

estimate_mentions <- function(
  svy,
  prefix,
  format,
  skip = NULL,
  sex = 'fem'
) {
  raw_import <- get_raw_import_for_sex(sex)
  dt <- get_dt_for_sex(sex)

  estimates <- rbindlist(lapply(
    get_idxs(format, skip, sex),
    function(x) {
      row <- estimate_totals_and_percentages(
        as.formula(paste('~', prefix, x, sep = '')),
        svy
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  
  estimates[
    , description := factorize(description, format, raw_import$Formats)
  ]

  estimates
}

create_pivot_table <- function(
  prefix,
  series,
  id_vars,
  source_dt
) {
  dt <- copy(
    source_dt[
      ,
      c(id_vars, paste(prefix, series, sep = '')),
      with = FALSE
    ]
  )

  dt <- melt(
    dt,
    id.vars = id_vars,
    variable.factor = FALSE,
    value.name = prefix
  )

  dt[
    ,
    (paste(prefix, 'ID', sep = '')) :=
      as.integer(sub(prefix, '', variable))
  ]

  dt[, variable := NULL]

  dt
}

create_NSFG_pivot_table <- function(prefix, series, id_vars = 'CASEID', sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  create_pivot_table(prefix, series, id_vars, raw_import$Data)
}

na_to_false <- function(x) {
  fifelse(is.na(x), FALSE, x)
}
```

```{r load-data}
fem1719 <- load_NSFG_data('2017_2019', 'FemResp')
male1719 <- load_NSFG_data('2017_2019', 'Male')

# Include missing level 13 for WHYNOTPGF format.
fem1719$Formats <- rbindlist(list(
  fem1719$Formats,
  data.table(
    format_name = 'WHYNOTPGF',
    factor_value = 13,
    factor_label = 'No menstrual cycle or menstrual irregularity'
  )
))
```

```{r process-fem-data, dependson=c('helpers', 'load-data')}
# Start working female respondents data table.
fem1719dt <- copy(fem1719$Data[, .(
  CASEID,
  SECU,
  SEST,
  WGT2017_2019
)])


# Copy variables to working data table and set them to factors.
set_variables_as_factors(
  variables = c(
    ATTRACT = 'ATTRACT',
    CONSTAT1 = 'CONSTATF',
    HADSEX = 'HADSEX',
    HPPREGQ = 'HPPREGQ',
    LSEXPREG = 'Y1N2RECF',
    P1YRELP = 'P1YRELP',
    POSIBLMN = 'Y1N5RDF',
    POSIBLPG = 'Y1N5RDF',
    PSURGSTR = 'Y1N5C',
    REASIMPP = 'REASP',
    REASIMPR = 'REASR',
    SEX3MO = 'Y1N2RECF',
    TUBS = 'Y1N5C',
    WHYNOUSING1 = 'WHYNOUSNG',
    WYNOLSTP = 'Y1N5RDF',
    WYNOTUSE = 'Y1N5RDF',
    YNOSEX = 'YNOSEX'
  )
)


# Create boolean variables for whether each contraceptive method was used at last intercourse within the past 3 months.
set_mentions_to_booleans(
  out_prefix = 'usedlast3m_meth',
  in_prefix = 'METH3M',
  in_series = 1:3,
  format = 'METH3MF',
  skip = 20:21
)


# If last intercourse within the past 3 months was with husband or cohabitating partner who has an active vasectomy, then set boolean variable of vasectomy use at last intercourse within the past 3 months to true.
fem1719dt[,
  usedlast3m_meth3 := fifelse(
    SEX3MO == 'YES' & PSURGSTR == 'YES' & (
      P1YRELP == 'Current husband or (current husband from whom she is separated)' |
      P1YRELP == 'Current cohabiting partner'
    ),
    TRUE,
    usedlast3m_meth3
  )
]


# If respondent has had intercourse in the past 3 months and has an active tubal ligation (or essure), then set boolean variable of tubal ligation use at last intercourse within the past 3 months to true.
fem1719dt[,
  usedlast3m_meth4 := fifelse(
    SEX3MO == 'YES' & TUBS == 'YES',
    TRUE,
    usedlast3m_meth4
  )
]


# Reset count of methods used at last intercourse within the past 3 months to include overrides of vasectomy and tubal ligation boolean variables.
set_mention_count_variable(fem1719dt, 'usedlast3m_meth')


# Create categorical variable for whether used contraception at last intercourse within the past 3 months.
fem1719dt[,
  usedlast3m := factor(fifelse(
    usedlast3m_meth_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]


# Create categorical variable specifying reasons not at increased risk for unintended pregnancy, if applicable.
fem1719dt[,
  usedlast3m_status := factor(
    fcase(
      usedlast3m_meth_count > 0,
        'Used at least one contraceptive method at last intercourse',
      SEX3MO != 'YES',
        'Did not have sexual intercourse with male in past 3 months',
      LSEXPREG == 'YES',
        'Pregnant in month of last intercourse',
      CONSTAT1 == 'Postpartum',
        'Postpartum',
      (WYNOTUSE == 'Yes' | WYNOLSTP == 'Yes'),
        'Currently trying to conceive',
      POSIBLPG == 'No',
        'Physically unable to conceive',
      POSIBLMN == 'No' & (
        P1YRELP == 'Current cohabiting partner' |
        P1YRELP == 'Current husband or (current husband from whom she is separated)'
      ),
        'Last intercourse was with partner who is physically unable to conceive',
      default = 'Otherwise did not use contraception at last intercourse'
    ),
    ordered = TRUE,
    levels = c(
      'Used at least one contraceptive method at last intercourse',
      'Did not have sexual intercourse with male in past 3 months',
      'Pregnant in month of last intercourse',
      'Postpartum',
      'Currently trying to conceive',
      'Physically unable to conceive',
      'Last intercourse was with partner who is physically unable to conceive',
      'Otherwise did not use contraception at last intercourse'
    )
  )
]


# Create categorical variable specifying whether respondent or partner wants to conceive.
fem1719dt[,
  pregnancy_intent_status := factor(
    fcase(
      WYNOTUSE == 'Not Applicable',
        'Outside of domain',
      WYNOTUSE == 'Yes',
        'Wants to get pregnant',
      HPPREGQ == 'Yes',
        'Partner wants respondent to get pregnant',
      WYNOTUSE == "Don't know" | HPPREGQ == "Don't know",
        "Don't know",
      WYNOTUSE == 'Refused' | HPPREGQ == 'Refused',
        'Refused',
      HPPREGQ == '(If volunteered:) no current partner',
        'Volunteered no current partner',
      WHYNOUSING1 != 'Not Applicable',
        'Not intending to conceive',
      default = 'No answer provided in public use data file'
    ),
    ordered = TRUE,
    levels = c(
      'Outside of domain',
      'Wants to get pregnant',
      'Partner wants respondent to get pregnant',
      "Don't know",
      'Refused',
      'Volunteered no current partner',
      'Not intending to conceive',
      'No answer provided in public use data file'
    )
  )
]


# Create boolean variables for whether each reason for not using contraception was mentioned.
set_mentions_to_booleans(
  out_prefix = 'nonuse_reason',
  in_prefix = 'WHYNOUSING',
  in_series = 1:5,
  format = 'WHYNOUSNG'
)


# Create boolean variables for whether each reason for not being able to get pregnant was mentioned.
set_mentions_to_booleans(
  out_prefix = 'pregnancy_impossible_reason',
  in_prefix = 'WHYNOTPG',
  in_series = 1:2,
  format = 'WHYNOTPGF'
)


# Create boolean variables for whether each method was used at all in the past 3 months.
fem1719METHXidxs <- get_idxs('METHSTOPF', skip = 98:99)
names(fem1719METHXidxs) <- paste('anyuse12m_meth', fem1719METHXidxs, sep = '')
fem1719METHX <- create_NSFG_pivot_table('METHX', 1:192)
fem1719METHX[, CMMHCALXID := ceiling(METHXID / 4)]
fem1719METHX <- fem1719METHX[
  create_NSFG_pivot_table(
    'CMMHCALX',
    1:48,
    c('CASEID', 'CMINTVW', 'CMLSTYR')
  ),
  on = c('CASEID', 'CMMHCALXID')
]
fem1719dt <- fem1719METHX[
  !is.na(METHX) & !is.na(CMMHCALX) &
    CMMHCALX > CMLSTYR &
    CMMHCALX <= CMINTVW,
  lapply(
    fem1719METHXidxs,
    \(x) any(.SD$METHX == x)
  ),
  by = CASEID
][fem1719dt, on = 'CASEID']
fem1719dt[,
  names(fem1719METHXidxs) := lapply(.SD, na_to_false),
  .SDcols = names(fem1719METHXidxs)
]


# Create SEX12MO variable for females using a pivot table.
fem1719dt <- create_NSFG_pivot_table(
  'CMMONSX',
  2:48,
  c('CASEID', 'CMINTVW', 'CMLSTYR')
)[
  create_NSFG_pivot_table('MONSX', 2:48),
  on = c(CASEID = 'CASEID', CMMONSXID = 'MONSXID')
][
  !is.na(MONSX) & MONSX == 1 &
    CMMONSX > CMLSTYR &
    CMMONSX <= CMINTVW,
  .(SEX12MO = .N > 1),
  by = CASEID
][
  fem1719dt,
  on = 'CASEID'
]
fem1719dt[, SEX12MO := na_to_false(SEX12MO)]


# If last intercourse within the past 12 months was with husband or cohabitating partner who has an active vasectomy, then set boolean variable of vasectomy use in the past 12 months to true.
fem1719dt[,
  anyuse12m_meth5 := fifelse(
    SEX12MO & PSURGSTR == 'YES' & (
        P1YRELP == 'Current husband or (current husband from whom she is separated)' |
        P1YRELP == 'Current cohabiting partner'
      ),
    TRUE,
    anyuse12m_meth5
  )
]


# If respondent has had intercourse in past 12 months and has an active tubal ligation (or essure), then set boolean variable of tubal ligation use at in the past 12 months to true.
fem1719dt[,
  anyuse12m_meth6 := fifelse(
    SEX12MO & TUBS == 'YES',
    TRUE,
    anyuse12m_meth6
  )
]


# Reset count of methods used in the past 12 months to include overrides of vasectomy and tubal ligation boolean variables.
set_mention_count_variable(fem1719dt, 'anyuse12m_meth')
```

```{r process-male-data, dependson=c('helpers', 'load-data')}
# Start working male respondents data table.
male1719dt <- copy(male1719$Data[, .(
  CASEID,
  SECU,
  SEST,
  WGT2017_2019
)])


# Copy variables to working data table and set them to factors.
set_variables_as_factors(
  sex = 'male',
  variables = c(
    ATTRACT = 'ATTRACT',
    CWPLMET201 = 'MTHDSV3F',
    CWPLUSE2 = 'Y1N5RDF',
    CWPPOSS = 'Y1N5RDF',
    CWPPRGNW ='Y1N5RDF',
    CWPTRYPG = 'Y1N5RDF',
    FATHPOSS = 'Y1N5RDF',
    HADSEX = 'HADSEX',
    P1COHABIT = 'Y1N5RDF',
    P1CURRWIFE = 'Y1N5RDF',
    PSURGSTR = 'N0Y1CF',
    PXCPREG = 'Y1N5RDF',
    PXLPMETH01 = 'MTHDSV3F',
    PXLPUSE = 'Y1N5RDF',
    PXLSXPRB = 'Y1N5RDF',
    PXTRYING = 'Y1N5RDF',
    RSURGSTR = 'N0Y1RDF',
    SEX3MO = 'SEX3MO',
    YNOSEX = 'YNOSEX'
  )
)


# Create boolean variables for whether each contraceptive method was used at last intercourse within the past 3 months.
set_mentions_to_booleans(
  sex = 'male',
  out_prefix = 'usedlast3m_meth',
  in_prefix = 'METH3M',
  in_series = 1:4,
  format = 'METH3MF',
  skip = 95:96
)


# If last intercourse within the past 3 months was with husband or cohabitating partner who has an tubal ligation (or other sterilizing procedure), then set boolean variable of tubal ligation use at last intercourse within the past 3 months to true.
male1719dt[,
  usedlast3m_meth5 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' &
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') &
      PSURGSTR == 'YES',
    TRUE,
    usedlast3m_meth5
  )
]


# If respondent has had intercourse in the past 3 months and has an active vasectomy, then set boolean variable of vasectomy use at last intercourse within the past 3 months to true.
male1719dt[,
  usedlast3m_meth3 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
    TRUE,
    usedlast3m_meth3
  )
]


# Reset count of methods used at last intercourse within the past 3 months to include overrides of tubal ligation and vasectomy boolean variables.
set_mention_count_variable(male1719dt, 'usedlast3m_meth')


# Create categorical variable for whether used contraception at last intercourse within the past 3 months.
male1719dt[,
  usedlast3m := factor(fifelse(
    usedlast3m_meth_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]


# Create categorical variable specifying reasons not at increased risk for unintended pregnancy, if applicable.
male1719dt[,
  usedlast3m_status := factor(
    fcase(
      usedlast3m_meth_count > 0,
        'Used at least one contraceptive method at last intercourse',
      SEX3MO != 'YES, HAD INTERCOURSE',
        'Did not have sexual intercourse with female in past 3 months',
      PXCPREG == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPRGNW == 'Yes'),
        'Last intercourse was with partner who is pregnant',
      PXTRYING == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPTRYPG == 'Yes'),
        'Last intercourse was with partner who is trying to conceive',
      FATHPOSS == 'No',
        'Physically unable to conceive',
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPOSS == 'No',
        'Last intercourse was with partner who is physically unable to concieve',
      default = 'Otherwise did not use contraception at last intercourse'
    ),
    ordered = TRUE,
    levels = c(
      'Used at least one contraceptive method at last intercourse',
      'Did not have sexual intercourse with female in past 3 months',
      'Last intercourse was with partner who is pregnant',
      'Last intercourse was with partner who is trying to conceive',
      'Physically unable to conceive',
      'Last intercourse was with partner who is physically unable to concieve',
      'Otherwise did not use contraception at last intercourse'
    )
  )
]


# Create categorical variable specifying whether respondent ever indicated he does not know if a partner used a method of contraception during last intercourse.
male1719dt[,
  not_aware := factor(fifelse(
    CWPLUSE2 == "Don't know" |
      CWPLMET201 == "Don't know" |
      PXLPUSE == "Don't know" |
      PXLPMETH01 == "Don't know" |
      PXLSXPRB == 'Yes' |
      PXLSXPRB == "Don't know",
    'Reports not knowing if partner used contraceptive method at last intercourse',
    'Does not report not knowing if partner used contraceptive method at last intercourse'
  ))
]
```


# Persons in Populations

Description: Persons aged 15-49 living in households in the United States as estimated by the NSFG

**Females**

```{r, dependson='process-fem-data'}
fem1719dt[, person := 1]

(estimate_totals_and_percentages(
  ~person,
  svy(fem1719dt)
) |> pretty_estimates())[
  , .(total, total_CI)
] |> kable()
```

**Males**

```{r, dependson='process-male-data'}
male1719dt[, person := 1]

(estimate_totals_and_percentages(
  ~person,
  svy(male1719dt)
) |> pretty_estimates())[
  , .(total, total_CI)
] |> kable()
```


# Currently Using Contraception

Domain: Persons aged 15-49 living in households in the United States

Description: By whether had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~usedlast3m,
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~usedlast3m,
  svy(male1719dt)
) |> pretty_estimates() |> kable()
```


# Reason for Nonuse

Domain: Persons not currently using contraception, as defined above

Description: Categorized into exclusive hierarchy, such that individuals categorized earlier in the hierarchy are not counted in later categories

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(fem1719dt),
    usedlast3m_meth_count == 0
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(male1719dt),
    usedlast3m_meth_count == 0
  )
) |> pretty_estimates() |> kable()
```


# Contraception Use Rate

Domain: Persons who had sexual intercourse with someone of the opposite sex in the 3 months preceding the interview, are not nor had last intercourse with someone who is pregnant, postpartum, trying to conceive, or physically infertile

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(fem1719dt),
    usedlast3m_status %in% c(
      'Used at least one contraceptive method at last intercourse',
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(male1719dt),
    usedlast3m_status %in% c(
      'Used at least one contraceptive method at last intercourse',
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> pretty_estimates() |> kable()
```


# Reported Ignorance of Contraceptive Use

Domain: Males who had intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~not_aware,
  subset(
    svy(male1719dt),
    SEX3MO == 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~not_aware,
  subset(
    svy(male1719dt),
    usedlast3m_status %in% c(
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> pretty_estimates() |> kable()
```


# Not Sexually Active

## Never Had Intercourse with Opposite Sex

Domain: Persons who have not had sexual intercourse with someone of the opposite sex in the 3 months preceding the interview

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  subset(
    svy(fem1719dt),
    SEX3MO != 'YES'
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  subset(
    svy(male1719dt),
    SEX3MO != 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```

### Reason for Never Having Intercourse

Domain: Persons who have never had sexual intercourse with someone of the opposite sex

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(YNOSEX),
  subset(
    svy(fem1719dt),
    HADSEX == 'NO, R NEVER HAD INTERCOURSE'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(YNOSEX),
  subset(
    svy(male1719dt),
    HADSEX == 'NO, R NEVER HAD INTERCOURSE'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```


## Attraction by Sex

Domain: Females who have not had sexual intercourse with a male in the past 3 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(fem1719dt),
    SEX3MO != 'YES'
  )
) |> pretty_estimates() |> kable()
```

Domain: Females who had sexual intercourse with a male in the past 3 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(fem1719dt),
    SEX3MO == 'YES'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who have not had sexual intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(male1719dt),
    SEX3MO != 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had sexual intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(male1719dt),
    SEX3MO == 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```


# Reason for Physical Inability to Conceive

Domain: Females who report being physically unable to get pregnant

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(REASIMPR),
  subset(
    svy(fem1719dt),
    POSIBLPG == 'No'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```

Domain: Females who report their partner is unable to father a child

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(REASIMPP),
  subset(
    svy(fem1719dt),
    POSIBLMN == 'No'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```


# Reason(s) for Nonuse

## Size of Domain

Description: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(WYNOTUSE != 'Not Applicable'),
  svy(fem1719dt)
)[description == TRUE] |> pretty_estimates() |> kable()
```

## Intent to Conceive

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, did not use a contraceptive in month of interview, and are not intending to conceive

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(pregnancy_intent_status),
  subset(
    svy(fem1719dt),
    WYNOTUSE != 'Not Applicable'
  )
) |> pretty_estimates() |> kable()
```

## Reason(s) for Nonuse When Not Intending to Conceive

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    pregnancy_intent_status == 'Not intending to conceive'
  ),
  prefix = 'nonuse_reason',
  format = 'WHYNOUSNG'
)[order(-total)] |> pretty_estimates() |> kable()
```

## Reason(s) Respondent Believes She Cannot Become Pregnant

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    nonuse_reason2
  ),
  prefix = 'pregnancy_impossible_reason',
  format = 'WHYNOTPGF'
)[order(-total)] |> pretty_estimates() |> kable()
```


# Method(s) at Last Intercourse

## Number of Methods

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By number of methods used at last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_meth_count),
  subset(
    svy(fem1719dt),
    usedlast3m_meth_count > 0
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_meth_count),
  subset(
    svy(male1719dt),
    usedlast3m_meth_count > 0
  )
) |> pretty_estimates() |> kable()
```


## Method(s) Used at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth_count > 0
  ),
  prefix = 'usedlast3m_meth',
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth_count > 0
  ),
  prefix = 'usedlast3m_meth',
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Method Used Exclusively at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used **one and only one** method of contraception during last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth_count == 1
  ),
  prefix = 'usedlast3m_meth',
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth_count == 1
  ),
  prefix = 'usedlast3m_meth',
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Proportion of Method Users Who Also Used Other Method(s)

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used each specific method of contraception during last intercourse

Description: Proportion who also used other method(s)

**Females**

```{r, dependson='process-fem-data'}
(function() {
  estimates <- rbindlist(lapply(
    get_idxs('METH3MF', 20:21, 'fem'),
    function(x) {
      row <- estimate_totals_and_percentages(
        ~I(usedlast3m_meth_count > 1),
        subset(
          svy(fem1719dt),
          fem1719dt[, get(sprintf('usedlast3m_meth%d', x))]
        )
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, 'METH3MF', fem1719$Formats)
  ]

  estimates
})()[!is.nan(total_CI_low)][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
(function() {
  estimates <- rbindlist(lapply(
    get_idxs('METH3MF', 95:96, 'male'),
    function(x) {
      row <- estimate_totals_and_percentages(
        ~I(usedlast3m_meth_count > 1),
        subset(
          svy(male1719dt),
          male1719dt[, get(sprintf('usedlast3m_meth%d', x))]
        )
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, 'METH3MF', male1719$Formats)
  ]

  estimates
})()[order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Calendar Method

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a calendar method during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth8
  ),
  prefix = 'usedlast3m_meth',
  skip = c(8, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth9
  ),
  prefix = 'usedlast3m_meth',
  skip = c(9, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Withdrawal

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used withdrawal during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth5
  ),
  prefix = 'usedlast3m_meth',
  skip = c(5, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth2
  ),
  prefix = 'usedlast3m_meth',
  skip = c(2, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Condoms

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used condoms during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth2
  ),
  prefix = 'usedlast3m_meth',
  skip = c(2, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth1
  ),
  prefix = 'usedlast3m_meth',
  skip = c(1, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Pill

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used the pill during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth1
  ),
  prefix = 'usedlast3m_meth',
  skip = c(1, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth4
  ),
  prefix = 'usedlast3m_meth',
  skip = c(4, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


# Method(s) Used in Past 12 Months

## Number of Methods

Domain: Females who have had intercourse with a male in the past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(anyuse12m_meth_count),
  subset(
    svy(fem1719dt),
    SEX12MO
  )
) |> pretty_estimates() |> kable()
```


* Past 12 months
    * Number of methods
    * By method(s) used
    * By method, among those using only one method
* Consistency
    * Did not use at last intercourse, but used at least one method in past 12 months
    * Did not use at last intercourse, but ever used contraception (females)
    * Frequency of any method use in past 12 months
    * Frequency of condom use in past 12 months
    * Frequency of condom use in past 12 months, among exclusive condom users
    * Frequency of condom use in past 4 weeks (females)
    * Number of missed pills in past 4 weeks (females)
* Use for reasons other than contraception
    * Condom, pill, IUD, and tubal ligation among females
    * Condom among males
* Ever (females)
    * By method(s)
    * By method(s) among those who have had intercourse with opposite sex
    * Ever discontinued due to dissatisfaction
    * Reason for dissatisfaction with pill
    * Reason for dissatisfaction with condoms
    * Reason for dissatisfaction with IUDs



# Things to Do

* Finish collecting estimates into this document
* Organize helper methods into NSFG-specific and more general
* Style plots and tables for output
* Write text of report
* Review situations in which universes do not match specifications in codebooks and follow up with NSFG administrators
* Compare own report with published reports
