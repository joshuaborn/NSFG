---
title: "Use and Nonuse of Contraception in the United States Reported in the 2017-2019 National Survey of Family Growth"
author: "Joshua Born"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
---

```{r setup, include=FALSE}
library(data.table)
library(here)
library(knitr)
library(survey)

source(here('R/import.R'))

i_am('reports/contraceptive_use_and_nonuse_in_the_united_states_2017-2019.Rmd')

opts_chunk$set(
  cache = TRUE,
  echo = TRUE,
  fig.height = 8,
  fig.width = 12,
  warning = FALSE
)
```

```{r helpers}
has_level <- function(x, ids) {
  !is.na(x) & is.element(as.integer(x), ids)
}

cm_greater <- function(x, y) {
  is.na(x) &
    x != 9998 &
    x != 9999 &
    is.na(y) &
    y != 9998 &
    y != 9999 &
    x > y
}

get_raw_import_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    fem1719
  } else {
    male1719
  }
}

get_dt_for_sex <- function(sex) {
  if (startsWith(sex, 'f')) {
    setDT(fem1719dt)
  } else {
    setDT(male1719dt)
  }
}

get_idxs <- function(format, skip = NULL, sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  idxs <- raw_import$Formats[format_name == format, factor_value]
  if (!is.null(skip)) {
    idxs[!is.element(idxs, skip)]
  } else {
    idxs
  }
}

set_mention_count_variable <- function(dt, prefix) {
  if (paste(prefix, 'count', sep = '_') %in% colnames(dt)) {
    dt[
      ,
      (paste(prefix, 'count', sep = '_')) := NULL
    ]
  }
  dt[
    ,
    (paste(prefix, 'count', sep = '_')) := rowSums(.SD),
    .SDcols = patterns(paste('^', prefix, sep = ''))
  ]
}

set_mentions_to_booleans <- function(
  out_prefix,
  in_prefix,
  in_series,
  format,
  skip = NULL,
  sex = 'fem'
) {
  dt <- get_dt_for_sex(sex)
  in_vars <- paste(in_prefix, in_series, sep = '')

  for (x in get_idxs(format, skip, sex)) {
    set(
      dt,
      j = paste(out_prefix, x, sep = ''),
      value = get_raw_import_for_sex(sex)$Data[
        ,
        lapply(.SD, \(col) has_level(col, x)),
        .SDcols = in_vars
      ] |> apply(1, any)
    )
  }

  set_mention_count_variable(dt, out_prefix)
}

set_variables_as_factors <- function(variables, sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  dt <- get_dt_for_sex(sex)

  for (x in seq(length(variables))) {
    variable_name <- names(variables)[x]
    format_name <- variables[x]
    values <- factorize(
      raw_import$Data[, get(variable_name)],
      format_name,
      raw_import$Formats
    )

    dt[, (variable_name) := ..values]
  }
}

estimate_totals_and_percentages <- function(f, svy) {
  totals <- svytotal(f, svy)
  totals_ci <- as.data.frame(confint(totals, df = degf(svy)))
  names(totals_ci) <- c('total_CI_low', 'total_CI_high')
  percentages <- svymean(f, svy)
  percentages_ci <- as.data.frame(confint(percentages, df = degf(svy)))
  names(percentages_ci) <- c('percentage_CI_low', 'percentage_CI_high')
  level_prefix <- as.character(f)
  level_prefix <- level_prefix[seq(2, length(level_prefix))]

  cbind(
    data.table(
      description = sub(level_prefix, '', names(totals), fixed = TRUE),
      total = as.vector(totals)
    ),
    totals_ci,
    data.table(
      percentage = as.vector(percentages)
    ),
    percentages_ci
  )
}

rounded_estimates <- function(dt) {
  cbind(
    dt[
      ,
      .SD,
      .SDcols = patterns('^[^(total)|(percentage)]')
    ],
    dt[
      ,
      lapply(.SD, \(col) round(col / 10^6, 3)),
      .SDcols = patterns('^total')
    ],
    dt[
      ,
      lapply(.SD, \(col) round(col, 3) * 100),
      .SDcols = patterns('^percentage')
    ]
  )
}

string_estimates <- function(dt) {
  dt[,
    .(
      description,
      total = sprintf("%.3fM", total),
      total_CI = sprintf(
        "(%.3fM, %.3fM)",
        total_CI_low,
        total_CI_high
      ),
      percentage = sprintf("%0.1f%%", percentage),
      percentage_CI = sprintf(
        "(%0.1f%%, %0.1f%%)",
        percentage_CI_low,
        percentage_CI_high
      )
    )
  ]
}

pretty_estimates <- function(dt) {
  dt |>
    rounded_estimates() |>
    string_estimates()
}

svy <- function(dt) {
  svydesign(
    ids = ~SECU,
    strata = ~SEST,
    data = dt,
    nest = TRUE,
    weights = ~WGT2017_2019
  )
}

estimate_mentions <- function(
  svy,
  prefix,
  format,
  skip = NULL,
  sex = 'fem'
) {
  raw_import <- get_raw_import_for_sex(sex)
  dt <- get_dt_for_sex(sex)

  estimates <- rbindlist(lapply(
    get_idxs(format, skip, sex),
    function(x) {
      row <- estimate_totals_and_percentages(
        as.formula(paste('~', prefix, x, sep = '')),
        svy
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  
  estimates[
    , description := factorize(description, format, raw_import$Formats)
  ]

  estimates
}

create_pivot_table <- function(
  prefix,
  series,
  id_vars,
  source_dt
) {
  dt <- copy(
    source_dt[
      ,
      c(id_vars, paste(prefix, series, sep = '')),
      with = FALSE
    ]
  )

  dt <- melt(
    dt,
    id.vars = id_vars,
    variable.factor = FALSE,
    value.name = prefix
  )

  dt[
    ,
    (paste(prefix, 'ID', sep = '')) :=
      as.integer(sub(prefix, '', variable))
  ]

  dt[, variable := NULL]

  dt
}

create_NSFG_pivot_table <- function(prefix, series, id_vars = 'CASEID', sex = 'fem') {
  raw_import <- get_raw_import_for_sex(sex)
  create_pivot_table(prefix, series, id_vars, raw_import$Data)
}

na_to_false <- function(x) {
  fifelse(is.na(x), FALSE, x)
}
```

```{r load-data}
fem1719 <- load_NSFG_data('2017_2019', 'FemResp')
male1719 <- load_NSFG_data('2017_2019', 'Male')

# Include missing level 13 for WHYNOTPGF format.
fem1719$Formats <- rbindlist(list(
  fem1719$Formats,
  data.table(
    format_name = 'WHYNOTPGF',
    factor_value = 13,
    factor_label = 'No menstrual cycle or menstrual irregularity'
  )
))
```

```{r process-fem-data, dependson=c('helpers', 'load-data')}
# Start working female respondents data table.
fem1719dt <- copy(fem1719$Data[, .(
  CASEID,
  SECU,
  SEST,
  WGT2017_2019,
  YUSEIUD1
)])


# Copy variables to working data table and set them to factors.
set_variables_as_factors(
  variables = c(
    ATTRACT = 'ATTRACT',
    CONDVAG = 'YESNONAF',
    CONSTAT1 = 'CONSTATF',
    EVERUSED = 'YESNONAF',
    HADSEX = 'HADSEX',
    HPPREGQ = 'HPPREGQ',
    LSEXPREG = 'Y1N2RECF',
    MISSPILL = 'MISSPILL',
    P12MOCON = 'P12MOCON',
    P1YRELP = 'P1YRELP',
    POSIBLMN = 'Y1N5RDF',
    POSIBLPG = 'Y1N5RDF',
    PSURGSTR = 'Y1N5C',
    PXNOFREQ = 'P12METHF',
    REASIMPP = 'REASP',
    REASIMPR = 'REASR',
    SEX3MO = 'Y1N2RECF',
    TUBS = 'Y1N5C',
    WHYCONDL = 'WHYCONDL',
    WHYNOUSING1 = 'WHYNOUSNG',
    WYNOLSTP = 'Y1N5RDF',
    WYNOTUSE = 'Y1N5RDF',
    YNOSEX = 'YNOSEX'
  )
)


# Create boolean variables for whether each contraceptive method was used at last intercourse within the past 3 months.
set_mentions_to_booleans(
  out_prefix = 'usedlast3m_meth',
  in_prefix = 'METH3M',
  in_series = 1:3,
  format = 'METH3MF',
  skip = 20:21
)


# If last intercourse within the past 3 months was with husband or cohabitating partner who has an active vasectomy, then set boolean variable of vasectomy use at last intercourse within the past 3 months to true.
fem1719dt[,
  usedlast3m_meth3 := fifelse(
    SEX3MO == 'YES' & PSURGSTR == 'YES' & (
      P1YRELP == 'Current husband or (current husband from whom she is separated)' |
      P1YRELP == 'Current cohabiting partner'
    ),
    TRUE,
    usedlast3m_meth3
  )
]


# If respondent has had intercourse in the past 3 months and has an active tubal ligation (or essure), then set boolean variable of tubal ligation use at last intercourse within the past 3 months to true.
fem1719dt[,
  usedlast3m_meth4 := fifelse(
    SEX3MO == 'YES' & TUBS == 'YES',
    TRUE,
    usedlast3m_meth4
  )
]


# Reset count of methods used at last intercourse within the past 3 months to include overrides of vasectomy and tubal ligation boolean variables.
set_mention_count_variable(fem1719dt, 'usedlast3m_meth')


# Create categorical variable for whether used contraception at last intercourse within the past 3 months.
fem1719dt[,
  usedlast3m := factor(fifelse(
    usedlast3m_meth_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]

# Create categorical variable specifying reasons not at increased risk for unintended pregnancy, if applicable.
fem1719dt[,
  usedlast3m_status := factor(
    fcase(
      usedlast3m_meth_count > 0,
        'Used at least one contraceptive method at last intercourse',
      SEX3MO != 'YES',
        'Did not have sexual intercourse with male in past 3 months',
      LSEXPREG == 'YES',
        'Pregnant in month of last intercourse',
      CONSTAT1 == 'Postpartum',
        'Postpartum',
      (WYNOTUSE == 'Yes' | WYNOLSTP == 'Yes'),
        'Currently trying to conceive',
      POSIBLPG == 'No',
        'Physically unable to conceive',
      POSIBLMN == 'No' & (
        P1YRELP == 'Current cohabiting partner' |
        P1YRELP == 'Current husband or (current husband from whom she is separated)'
      ),
        'Last intercourse was with partner who is physically unable to conceive',
      default = 'Otherwise did not use contraception at last intercourse'
    ),
    ordered = TRUE,
    levels = c(
      'Used at least one contraceptive method at last intercourse',
      'Did not have sexual intercourse with male in past 3 months',
      'Pregnant in month of last intercourse',
      'Postpartum',
      'Currently trying to conceive',
      'Physically unable to conceive',
      'Last intercourse was with partner who is physically unable to conceive',
      'Otherwise did not use contraception at last intercourse'
    )
  )
]


# Create categorical variable specifying whether respondent or partner wants to conceive.
fem1719dt[,
  pregnancy_intent_status := factor(
    fcase(
      WYNOTUSE == 'Not Applicable',
        'Outside of domain',
      WYNOTUSE == 'Yes',
        'Wants to get pregnant',
      HPPREGQ == 'Yes',
        'Partner wants respondent to get pregnant',
      WYNOTUSE == "Don't know" | HPPREGQ == "Don't know",
        "Don't know",
      WYNOTUSE == 'Refused' | HPPREGQ == 'Refused',
        'Refused',
      HPPREGQ == '(If volunteered:) no current partner',
        'Volunteered no current partner',
      WHYNOUSING1 != 'Not Applicable',
        'Not intending to conceive',
      default = 'No answer provided in public use data file'
    ),
    ordered = TRUE,
    levels = c(
      'Outside of domain',
      'Wants to get pregnant',
      'Partner wants respondent to get pregnant',
      "Don't know",
      'Refused',
      'Volunteered no current partner',
      'Not intending to conceive',
      'No answer provided in public use data file'
    )
  )
]


# Create boolean variables for whether each reason for not using contraception was mentioned.
set_mentions_to_booleans(
  out_prefix = 'nonuse_reason',
  in_prefix = 'WHYNOUSING',
  in_series = 1:5,
  format = 'WHYNOUSNG'
)


# Create boolean variables for whether each reason for not being able to get pregnant was mentioned.
set_mentions_to_booleans(
  out_prefix = 'pregnancy_impossible_reason',
  in_prefix = 'WHYNOTPG',
  in_series = 1:2,
  format = 'WHYNOTPGF'
)


# Create boolean variables for whether each method was used at all in the past 3 months.
fem1719METHXidxs <- get_idxs('METHHXF', skip = c(1:2, 22:23, 55, 98:99))
names(fem1719METHXidxs) <- paste('anyuse12m_meth', fem1719METHXidxs, sep = '')
fem1719METHX <- create_NSFG_pivot_table('METHX', 1:192)
fem1719METHX[, CMMHCALXID := ceiling(METHXID / 4)]
fem1719METHX <- fem1719METHX[
  create_NSFG_pivot_table(
    'CMMHCALX',
    1:48,
    c('CASEID', 'CMINTVW', 'CMLSTYR')
  ),
  on = c('CASEID', 'CMMHCALXID')
]
fem1719dt <- fem1719METHX[
  !is.na(METHX) & !is.na(CMMHCALX) &
    CMMHCALX > CMLSTYR &
    CMMHCALX <= CMINTVW,
  lapply(
    fem1719METHXidxs,
    \(x) any(.SD$METHX == x)
  ),
  by = CASEID
][fem1719dt, on = 'CASEID']
fem1719dt[,
  names(fem1719METHXidxs) := lapply(.SD, na_to_false),
  .SDcols = names(fem1719METHXidxs)
]


# Create sex12mo variable for females using a pivot table.
fem1719dt <- create_NSFG_pivot_table(
  'CMMONSX',
  2:48,
  c('CASEID', 'CMINTVW', 'CMLSTYR')
)[
  create_NSFG_pivot_table('MONSX', 2:48),
  on = c(CASEID = 'CASEID', CMMONSXID = 'MONSXID')
][
  !is.na(MONSX) & MONSX == 1 &
    CMMONSX > CMLSTYR &
    CMMONSX <= CMINTVW,
  .(sex12mo = .N > 1),
  by = CASEID
][
  fem1719dt,
  on = 'CASEID'
]
fem1719dt[, sex12mo := na_to_false(sex12mo)]


# If last intercourse within the past 12 months was with husband or cohabitating partner who has an active vasectomy, then set boolean variable of vasectomy use in the past 12 months to true.
fem1719dt[,
  anyuse12m_meth5 := fifelse(
    sex12mo & PSURGSTR == 'YES' & (
        P1YRELP == 'Current husband or (current husband from whom she is separated)' |
        P1YRELP == 'Current cohabiting partner'
      ),
    TRUE,
    anyuse12m_meth5
  )
]


# If respondent has had intercourse in past 12 months and has an active tubal ligation (or essure), then set boolean variable of tubal ligation use at in the past 12 months to true.
fem1719dt[,
  anyuse12m_meth6 := fifelse(
    sex12mo & TUBS == 'YES',
    TRUE,
    anyuse12m_meth6
  )
]


# Reset count of methods used in the past 12 months to include overrides of vasectomy and tubal ligation boolean variables.
set_mention_count_variable(fem1719dt, 'anyuse12m_meth')


# Create categorical variable specifying consistency of any contraceptive method use over previous 12 months that combines P12MOCON and PXNOFREQ.
fem1719dt[,
  anyuse12m_consistency := factor(
    fcase(
      P12MOCON == 'Every time',
        'Every time',
      PXNOFREQ != 'Not Applicable',
        as.character(PXNOFREQ),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]


# Create boolean variables for whether each method was used in the month preceding the interview.
set_mentions_to_booleans(
  out_prefix = 'lastmonth_meth',
  in_prefix = 'LSTMONMETH',
  in_series = 1:4,
  format = 'METHHXF',
  skip = c(1:2, 22:23, 55, 98:99)
)


# Create boolean variables for whether each method was used in the month of the interview.
set_mentions_to_booleans(
  out_prefix = 'thismonth_meth',
  in_prefix = 'CURRMETH',
  in_series = 1:4,
  format = 'METHHXF',
  skip = c(1:2, 22:23, 55, 98:99)
)


# Create boolean variables for each reason for using the pill.
set_mentions_to_booleans(
  out_prefix = 'whypill_reason',
  in_prefix = 'YUSEPILL',
  in_series = 1:6,
  format = 'YUSEMTHF'
)


# Create categorical variable reflecting overall motivation for pill use.
fem1719dt[,
  pill_motivation := factor(
    fcase(
      whypill_reason1 & !(
        whypill_reason2 |
        whypill_reason3 |
        whypill_reason4 |
        whypill_reason5 |
        whypill_reason6 |
        whypill_reason7 |
        whypill_reason8
      ), 'Only for birth control',
      !whypill_reason1 & (
        whypill_reason2 |
        whypill_reason3 |
        whypill_reason4 |
        whypill_reason5 |
        whypill_reason6 |
        whypill_reason7 |
        whypill_reason8
      ), 'Only for reasons other than contraception',
      default = 'For both reasons'
    )
  )
]


# Create boolean variables for each reason for using an IUD.
set_mentions_to_booleans(
  out_prefix = 'whyiud_reason',
  in_prefix = 'YUSEIUD',
  in_series = 1:6,
  format = 'YUSEMTHF'
)


# Create categorical variable reflecting overall motivation for IUD use.
fem1719dt[,
  iud_motivation := factor(
    fcase(
      whyiud_reason99,
      "Don't know",
      whyiud_reason1 & (
        whyiud_reason2 |
        whyiud_reason3 |
        whyiud_reason4 |
        whyiud_reason5 |
        whyiud_reason6 |
        whyiud_reason7 |
        whyiud_reason8
      ),
      'For both reasons',
      whyiud_reason1 & !(
        whyiud_reason2 |
        whyiud_reason3 |
        whyiud_reason4 |
        whyiud_reason5 |
        whyiud_reason6 |
        whyiud_reason7 |
        whyiud_reason8
      ),
      'Only for contraception',
      !whyiud_reason1 & (
        whyiud_reason2 |
        whyiud_reason3 |
        whyiud_reason4 |
        whyiud_reason5 |
        whyiud_reason6 |
        whyiud_reason7 |
        whyiud_reason8
      ),
      'Only for reasons other than contraception',
      default = 'Not Applicable'
    )
  )
]
```

```{r process-male-data, dependson=c('helpers', 'load-data')}
# Start working male respondents data table.
male1719dt <- copy(male1719$Data[, .(
  CASEID,
  CMLSTYR,
  CMLSXCWP,
  CONDFREQ,
  CWPALLBC01,
  PXCONFRQ,
  PXMETHOD01,
  SECU,
  SEST,
  WGT2017_2019
)])


# Copy variables to working data table and set them to factors.
set_variables_as_factors(
  sex = 'male',
  variables = c(
    ATTRACT = 'ATTRACT',
    CONDVAG = 'YESNONAF',
    CWPLMET201 = 'MTHDSV3F',
    CWPLUSE2 = 'Y1N5RDF',
    CWPNOFRQ = 'OFTIMEF',
    CWPPOSS = 'Y1N5RDF',
    CWPPRGNW ='Y1N5RDF',
    CWPTRYPG = 'Y1N5RDF',
    FATHPOSS = 'Y1N5RDF',
    HADSEX = 'HADSEX',
    P12MOCON = 'OFTIMEF',
    P12MOCONO = 'Y1N5RDF',
    P1COHABIT = 'Y1N5RDF',
    P1CURRWIFE = 'Y1N5RDF',
    PSURGSTR = 'N0Y1CF',
    PXCPREG = 'Y1N5RDF',
    PXLPMETH01 = 'MTHDSV3F',
    PXLPUSE = 'Y1N5RDF',
    PXLSXPRB = 'Y1N5RDF',
    PXNOFREQ = 'OFTIMEF',
    PXTRYING = 'Y1N5RDF',
    RSURGSTR = 'N0Y1RDF',
    SEX12MO = 'SEX3MO',
    SEX3MO = 'SEX3MO',
    WHYCONDL = 'WHYCONDF',
    YNOSEX = 'YNOSEX'
  )
)


# Create boolean variables for whether each contraceptive method was used at last intercourse within the past 3 months.
set_mentions_to_booleans(
  sex = 'male',
  out_prefix = 'usedlast3m_meth',
  in_prefix = 'METH3M',
  in_series = 1:4,
  format = 'METH3MF',
  skip = 95:96
)


# If last intercourse within the past 3 months was with wife or cohabitating partner who has an tubal ligation (or other sterilizing procedure), then set boolean variable of tubal ligation use at last intercourse within the past 3 months to true.
male1719dt[,
  usedlast3m_meth5 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' &
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') &
      PSURGSTR == 'YES',
    TRUE,
    usedlast3m_meth5
  )
]


# If respondent has had intercourse in the past 3 months and has an active vasectomy, then set boolean variable of vasectomy use at last intercourse within the past 3 months to true.
male1719dt[,
  usedlast3m_meth3 := fifelse(
    SEX3MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
    TRUE,
    usedlast3m_meth3
  )
]


# Reset count of methods used at last intercourse within the past 3 months to include overrides of tubal ligation and vasectomy boolean variables.
set_mention_count_variable(male1719dt, 'usedlast3m_meth')


# Create categorical variable for whether used contraception at last intercourse within the past 3 months.
male1719dt[,
  usedlast3m := factor(fifelse(
    usedlast3m_meth_count > 0,
    'Currently using contraception',
    'Not currently using contraception'
  ))
]


# Create categorical variable specifying reasons not at increased risk for unintended pregnancy, if applicable.
male1719dt[,
  usedlast3m_status := factor(
    fcase(
      usedlast3m_meth_count > 0,
        'Used at least one contraceptive method at last intercourse',
      SEX3MO != 'YES, HAD INTERCOURSE',
        'Did not have sexual intercourse with female in past 3 months',
      PXCPREG == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPRGNW == 'Yes'),
        'Last intercourse was with partner who is pregnant',
      PXTRYING == 'Yes' | ((P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPTRYPG == 'Yes'),
        'Last intercourse was with partner who is trying to conceive',
      FATHPOSS == 'No',
        'Physically unable to conceive',
      (P1CURRWIFE == 'Yes' | P1COHABIT == 'Yes') & CWPPOSS == 'No',
        'Last intercourse was with partner who is physically unable to concieve',
      default = 'Otherwise did not use contraception at last intercourse'
    ),
    ordered = TRUE,
    levels = c(
      'Used at least one contraceptive method at last intercourse',
      'Did not have sexual intercourse with female in past 3 months',
      'Last intercourse was with partner who is pregnant',
      'Last intercourse was with partner who is trying to conceive',
      'Physically unable to conceive',
      'Last intercourse was with partner who is physically unable to concieve',
      'Otherwise did not use contraception at last intercourse'
    )
  )
]


# Create categorical variable specifying whether respondent ever indicated he does not know if a partner used a method of contraception during last intercourse.
male1719dt[,
  not_aware := factor(fifelse(
    CWPLUSE2 == "Don't know" |
      CWPLMET201 == "Don't know" |
      PXLPUSE == "Don't know" |
      PXLPMETH01 == "Don't know" |
      PXLSXPRB == 'Yes' |
      PXLSXPRB == "Don't know",
    'Reports not knowing if partner used contraceptive method at last intercourse',
    'Does not report not knowing if partner used contraceptive method at last intercourse'
  ))
]


# Create boolean variables for whether each specific method was used in past 12 months.
for (x in get_idxs('MTHDSV1F', skip = c(10, 98:99), sex = 'male')) {
  male1719dt[,
    (sprintf('anyuse12m_meth%d', x)) := male1719$Data[,
      !is.na(
        (cm_greater(CMLSXCWP, CMLSTYR) & (
          CWPLMET11 == x |
          CWPLMET12 == x |
          CWPLMET13 == x |
          CWPLMET201 == x |
          CWPLMET202 == x
        )) |
        (cm_greater(CMFSXCWP, CMLSTYR) & (
          CWPFMET01 == x |
          CWPFMET02 == x |
          CWPFMET03 == x |
          CWPFMET04 == x |
          CWPFMET05 == x
        )) |
        CWPALLBC01 == x |
        CWPALLBC02 == x |
        CWPALLBC03 == x |
        CWPALLBC04 == x |
        CWPALLBC05 == x |
        (cm_greater(CMLSXP1, CMLSTYR) & (
          PXLRMETH1 == x |
          PXLRMETH2 == x |
          PXLRMETH3 == x |
          PXLPMETH01 == x |
          PXLPMETH02 == x |
          PXLPMETH03 == x
        )) |
        (cm_greater(CMLSXP2, CMLSTYR) & (
          PXLRMETH5 == x |
          PXLRMETH6 == x |
          PXLRMETH7 == x |
          PXLPMETH11 == x |
          PXLPMETH12 == x |
          PXLPMETH13 == x
        )) |
        (cm_greater(CMLSXP3, CMLSTYR) & (
          PXLRMETH9 == x |
          PXLRMETH10 == x |
          PXLRMETH11 == x |
          PXLPMETH21 == x |
          PXLPMETH22 == x |
          PXLPMETH23 == x
        )) |
        (cm_greater(CMFSXP, CMLSTYR) & (
          PXFMETH01 == x |
          PXFMETH02 == x |
          PXFMETH03 == x |
          PXFMETH04 == x
        )) |
        (cm_greater(CMFSXP2, CMLSTYR) & (
          PXFMETH14 == x |
          PXFMETH15 == x |
          PXFMETH16 == x |
          PXFMETH17 == x
        )) |
        (cm_greater(CMFSXP3, CMLSTYR) & (
          PXFMETH27 == x |
          PXFMETH28 == x |
          PXFMETH29 == x |
          PXFMETH30 == x
        )) |
        PXMETHOD01 == x |
        PXMETHOD02 == x |
        PXMETHOD03 == x |
        PXMETHOD04 == x |
        PXMETHOD05 == x |
        PXMETHOD14 == x |
        PXMETHOD15 == x |
        PXMETHOD16 == x |
        PXMETHOD17 == x |
        PXMETHOD18 == x |
        PXMETHOD27 == x |
        PXMETHOD28 == x |
        PXMETHOD29 == x |
        PXMETHOD30 == x |
        PXMETHOD31 == x
      )
    ]
  ]
}

# Set a boolean variable for whether "Something else" was used in past 12 months separately because its encoding collides with "Contraceptive patch (Ortho-Evra)".
male1719dt[,
  anyuse12m_meth13 := male1719$Data[,
    !is.na(
      (cm_greater(CMLSXCWP, CMLSTYR) & (
        CWPLMET11 == 10 |
        CWPLMET12 == 10 |
        CWPLMET13 == 10 |
        CWPLMET201 == 13 |
        CWPLMET202 == 13
      )) |
      (cm_greater(CMFSXCWP, CMLSTYR) & (
        CWPFMET01 == 13 |
        CWPFMET02 == 13 |
        CWPFMET03 == 13 |
        CWPFMET04 == 13 |
        CWPFMET05 == 13
      )) |
      CWPALLBC01 == 13 |
      CWPALLBC02 == 13 |
      CWPALLBC03 == 13 |
      CWPALLBC04 == 13 |
      CWPALLBC05 == 13 |
      (cm_greater(CMLSXP1, CMLSTYR) & (
        PXLRMETH1 == 10 |
        PXLRMETH2 == 10 |
        PXLRMETH3 == 10 |
        PXLPMETH01 == 13 |
        PXLPMETH02 == 13 |
        PXLPMETH03 == 13
      )) |
      (cm_greater(CMLSXP2, CMLSTYR) & (
        PXLRMETH5 == 10 |
        PXLRMETH6 == 10 |
        PXLRMETH7 == 10 |
        PXLPMETH11 == 13 |
        PXLPMETH12 == 13 |
        PXLPMETH13 == 13
      )) |
      (cm_greater(CMLSXP3, CMLSTYR) & (
        PXLRMETH9 == 10 |
        PXLRMETH10 == 10 |
        PXLRMETH11 == 10 |
        PXLPMETH21 == 13 |
        PXLPMETH22 == 13 |
        PXLPMETH23 == 13
      )) |
      (cm_greater(CMFSXP, CMLSTYR) & (
        PXFMETH01 == 13 |
        PXFMETH02 == 13 |
        PXFMETH03 == 13 |
        PXFMETH04 == 13
      )) |
      (cm_greater(CMFSXP2, CMLSTYR) & (
        PXFMETH14 == 13 |
        PXFMETH15 == 13 |
        PXFMETH16 == 13 |
        PXFMETH17 == 13
      )) |
      (cm_greater(CMFSXP3, CMLSTYR) & (
        PXFMETH27 == 13 |
        PXFMETH28 == 13 |
        PXFMETH29 == 13 |
        PXFMETH30 == 13
      )) |
      PXMETHOD01 == 13 |
      PXMETHOD02 == 13 |
      PXMETHOD03 == 13 |
      PXMETHOD04 == 13 |
      PXMETHOD05 == 13 |
      PXMETHOD14 == 13 |
      PXMETHOD15 == 13 |
      PXMETHOD16 == 13 |
      PXMETHOD17 == 13 |
      PXMETHOD18 == 13 |
      PXMETHOD27 == 13 |
      PXMETHOD28 == 13 |
      PXMETHOD29 == 13 |
      PXMETHOD30 == 13 |
      PXMETHOD31 == 13
    )
  ]
]


# Set a boolean variable for whether "Contraceptive patch (Ortho-Evra)" was used in past 12 months separately because its encoding collides with "Something else".
male1719dt[,
  anyuse12m_meth10 := male1719$Data[,
    !is.na(
      (cm_greater(CMLSXCWP, CMLSTYR) & (
        CWPLMET201 == 10 |
        CWPLMET202 == 10
      )) |
      (cm_greater(CMFSXCWP, CMLSTYR) & (
        CWPFMET01 == 10 |
        CWPFMET02 == 10 |
        CWPFMET03 == 10 |
        CWPFMET04 == 10 |
        CWPFMET05 == 10
      )) |
      CWPALLBC01 == 10 |
      CWPALLBC02 == 10 |
      CWPALLBC03 == 10 |
      CWPALLBC04 == 10 |
      CWPALLBC05 == 10 |
      (cm_greater(CMLSXP1, CMLSTYR) & (
        PXLPMETH01 == 10 |
        PXLPMETH02 == 10 |
        PXLPMETH03 == 10
      )) |
      (cm_greater(CMLSXP2, CMLSTYR) & (
        PXLPMETH11 == 10 |
        PXLPMETH12 == 10 |
        PXLPMETH13 == 10
      )) |
      (cm_greater(CMLSXP3, CMLSTYR) & (
        PXLPMETH21 == 10 |
        PXLPMETH22 == 10 |
        PXLPMETH23 == 10
      )) |
      (cm_greater(CMFSXP, CMLSTYR) & (
        PXFMETH01 == 10 |
        PXFMETH02 == 10 |
        PXFMETH03 == 10 |
        PXFMETH04 == 10
      )) |
      (cm_greater(CMFSXP2, CMLSTYR) & (
        PXFMETH14 == 10 |
        PXFMETH15 == 10 |
        PXFMETH16 == 10 |
        PXFMETH17 == 10
      )) |
      (cm_greater(CMFSXP3, CMLSTYR) & (
        PXFMETH27 == 10 |
        PXFMETH28 == 10 |
        PXFMETH29 == 10 |
        PXFMETH30 == 10
      )) |
      PXMETHOD01 == 10 |
      PXMETHOD02 == 10 |
      PXMETHOD03 == 10 |
      PXMETHOD04 == 10 |
      PXMETHOD05 == 10 |
      PXMETHOD14 == 10 |
      PXMETHOD15 == 10 |
      PXMETHOD16 == 10 |
      PXMETHOD17 == 10 |
      PXMETHOD18 == 10 |
      PXMETHOD27 == 10 |
      PXMETHOD28 == 10 |
      PXMETHOD29 == 10 |
      PXMETHOD30 == 10 |
      PXMETHOD31 == 10
    )
  ]
]


# If respondent has had intercourse in the past 12 months and has an active vasectomy, then set boolean variable of vasectomy use at in the past 12 months to true.
male1719dt[,
  anyuse12m_meth3 := fifelse(
    SEX12MO == 'YES, HAD INTERCOURSE' & RSURGSTR == 'YES',
    TRUE,
    anyuse12m_meth3
  )
]


# If last intercourse with wife or cohabitating partner was within the past 12 months, and wife or cohabitating partner has an active tubal ligation (or other sterilizing procedure), then set boolean variable of tubal ligation use at in the past 12 months to true.
male1719dt[,
  anyuse12m_meth5 := fifelse(
    SEX12MO == 'YES, HAD INTERCOURSE' &
      cm_greater(CMLSXCWP, CMLSTYR) &
      PSURGSTR == 'YES',
    TRUE,
    anyuse12m_meth5
  )
]


# Count number of contraceptive methods used in past 12 months.
set_mention_count_variable(male1719dt, 'anyuse12m_meth')


# Create categorical variable specifying consistency of any contraceptive method use over previous 12 months with wife or cohabitating partner that combines CONDFREQ and CWPNOFRQ.
male1719dt[,
  anyuse12m_wcp_consistency := factor(
    fcase(
      CONDFREQ == 100,
        'Every time',
      CWPNOFRQ != 'Not Applicable',
        as.character(CWPNOFRQ),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]


# Create categorical variable specifying consistency of any contraceptive method use over previous 12 months with last partner, who is not wife or cohabitating partner, that combines PXCONFRQ and PXNOFREQ.
male1719dt[,
  anyuse12m_p1_consistency := factor(
    fcase(
      PXCONFRQ == 100,
        'Every time',
      PXNOFREQ != 'Not Applicable',
        as.character(PXNOFREQ),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]

# Create categorical variable specifying consistency of condom use over previous 12 months that combines P12MOCONO and P12MOCON.
male1719dt[,
  condom12m_consistency := factor(
    fcase(
      P12MOCONO == 'Yes',
        'Every time',
      P12MOCONO == 'No',
        'None of the time',
      !is.na(P12MOCON),
        as.character(P12MOCON),
      default = 'No answer provided in public use data files'
    ),
    ordered = TRUE,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      "Don't know",
      'No answer provided in public use data files'
    )
  )
]
```


# Persons in Populations

Description: Persons aged 15-49 living in households in the United States as estimated by the NSFG

**Females**

```{r, dependson='process-fem-data'}
fem1719dt[, person := 1]

(estimate_totals_and_percentages(
  ~person,
  svy(fem1719dt)
) |> pretty_estimates())[
  , .(total, total_CI)
] |> kable()
```

**Males**

```{r, dependson='process-male-data'}
male1719dt[, person := 1]

(estimate_totals_and_percentages(
  ~person,
  svy(male1719dt)
) |> pretty_estimates())[
  , .(total, total_CI)
] |> kable()
```


# Currently Using Contraception

Domain: Persons aged 15-49 living in households in the United States

Description: By whether had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~usedlast3m,
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~usedlast3m,
  svy(male1719dt)
) |> pretty_estimates() |> kable()
```


# Reason for Nonuse

Domain: Persons not currently using contraception, as defined above

Description: Categorized into exclusive hierarchy, such that individuals categorized earlier in the hierarchy are not counted in later categories

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(fem1719dt),
    usedlast3m_meth_count == 0
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(male1719dt),
    usedlast3m_meth_count == 0
  )
) |> pretty_estimates() |> kable()
```


# Contraception Use Rate

Domain: Persons who had sexual intercourse with someone of the opposite sex in the 3 months preceding the interview, are not nor had last intercourse with someone who is pregnant, postpartum, trying to conceive, or physically infertile

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(fem1719dt),
    usedlast3m_status %in% c(
      'Used at least one contraceptive method at last intercourse',
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_status),
  subset(
    svy(male1719dt),
    usedlast3m_status %in% c(
      'Used at least one contraceptive method at last intercourse',
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> pretty_estimates() |> kable()
```


# Reported Ignorance of Contraceptive Use

Domain: Males who had intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~not_aware,
  subset(
    svy(male1719dt),
    SEX3MO == 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~not_aware,
  subset(
    svy(male1719dt),
    usedlast3m_status %in% c(
      'Otherwise did not use contraception at last intercourse'
    )
  )
) |> pretty_estimates() |> kable()
```


# Not Sexually Active

## Never Had Intercourse with Opposite Sex

Domain: Persons who have not had sexual intercourse with someone of the opposite sex in the 3 months preceding the interview

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  subset(
    svy(fem1719dt),
    SEX3MO != 'YES'
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(HADSEX),
  subset(
    svy(male1719dt),
    SEX3MO != 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```

### Reason for Never Having Intercourse

Domain: Persons who have never had sexual intercourse with someone of the opposite sex

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(YNOSEX),
  subset(
    svy(fem1719dt),
    HADSEX == 'NO, R NEVER HAD INTERCOURSE'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(YNOSEX),
  subset(
    svy(male1719dt),
    HADSEX == 'NO, R NEVER HAD INTERCOURSE'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```


## Attraction by Sex

Domain: Females who have not had sexual intercourse with a male in the past 3 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(fem1719dt),
    SEX3MO != 'YES'
  )
) |> pretty_estimates() |> kable()
```

Domain: Females who had sexual intercourse with a male in the past 3 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(fem1719dt),
    SEX3MO == 'YES'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who have not had sexual intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(male1719dt),
    SEX3MO != 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had sexual intercourse with a female in the past 3 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(ATTRACT),
  subset(
    svy(male1719dt),
    SEX3MO == 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```


# Reason for Physical Inability to Conceive

Domain: Females who report being physically unable to get pregnant

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(REASIMPR),
  subset(
    svy(fem1719dt),
    POSIBLPG == 'No'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```

Domain: Females who report their partner is unable to father a child

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(REASIMPP),
  subset(
    svy(fem1719dt),
    POSIBLMN == 'No'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```


# Reason(s) for Nonuse

## Size of Domain

Description: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(WYNOTUSE != 'Not Applicable'),
  svy(fem1719dt)
)[description == TRUE] |> pretty_estimates() |> kable()
```

## Intent to Conceive

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, did not use a contraceptive in month of interview, and are not intending to conceive

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(pregnancy_intent_status),
  subset(
    svy(fem1719dt),
    WYNOTUSE != 'Not Applicable'
  )
) |> pretty_estimates() |> kable()
```

## Reason(s) for Nonuse When Not Intending to Conceive

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    pregnancy_intent_status == 'Not intending to conceive'
  ),
  prefix = 'nonuse_reason',
  format = 'WHYNOUSNG'
)[order(-total)] |> pretty_estimates() |> kable()
```

## Reason(s) Respondent Believes She Cannot Become Pregnant

Domain: Females who are not currently pregnant, had intercourse in the month of interview, are neither sterilized nor sterile, and did not use a contraceptive in month of interview

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    nonuse_reason2
  ),
  prefix = 'pregnancy_impossible_reason',
  format = 'WHYNOTPGF'
)[order(-total)] |> pretty_estimates() |> kable()
```


# Method(s) at Last Intercourse

## Number of Methods

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By number of methods used at last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_meth_count),
  subset(
    svy(fem1719dt),
    usedlast3m_meth_count > 0
  )
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(usedlast3m_meth_count),
  subset(
    svy(male1719dt),
    usedlast3m_meth_count > 0
  )
) |> pretty_estimates() |> kable()
```


## Method(s) Used at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a method of contraception during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth_count > 0
  ),
  prefix = 'usedlast3m_meth',
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth_count > 0
  ),
  prefix = 'usedlast3m_meth',
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Method Used Exclusively at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used **one and only one** method of contraception during last intercourse

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth_count == 1
  ),
  prefix = 'usedlast3m_meth',
  skip = 20:21,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth_count == 1
  ),
  prefix = 'usedlast3m_meth',
  skip = 95:96,
  format = 'METH3MF'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Proportion of Method Users Who Also Used Other Method(s)

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used each specific method of contraception during last intercourse

Description: Proportion who also used other method(s)

**Females**

```{r, dependson='process-fem-data'}
(function() {
  estimates <- rbindlist(lapply(
    get_idxs('METH3MF', 20:21, 'fem'),
    function(x) {
      row <- estimate_totals_and_percentages(
        ~I(usedlast3m_meth_count > 1),
        subset(
          svy(fem1719dt),
          fem1719dt[, get(sprintf('usedlast3m_meth%d', x))]
        )
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, 'METH3MF', fem1719$Formats)
  ]

  estimates
})()[!is.nan(total_CI_low)][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
(function() {
  estimates <- rbindlist(lapply(
    get_idxs('METH3MF', 95:96, 'male'),
    function(x) {
      row <- estimate_totals_and_percentages(
        ~I(usedlast3m_meth_count > 1),
        subset(
          svy(male1719dt),
          male1719dt[, get(sprintf('usedlast3m_meth%d', x))]
        )
      )[
        description == TRUE
      ]
      row[, description := x]
      row
    }
  ))

  estimates[
    , description := factorize(description, 'METH3MF', male1719$Formats)
  ]

  estimates
})()[order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Calendar Method

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used a calendar method during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth8
  ),
  prefix = 'usedlast3m_meth',
  skip = c(8, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth9
  ),
  prefix = 'usedlast3m_meth',
  skip = c(9, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Withdrawal

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used withdrawal during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth5
  ),
  prefix = 'usedlast3m_meth',
  skip = c(5, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth2
  ),
  prefix = 'usedlast3m_meth',
  skip = c(2, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Condoms

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used condoms during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth2
  ),
  prefix = 'usedlast3m_meth',
  skip = c(2, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth1
  ),
  prefix = 'usedlast3m_meth',
  skip = c(1, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


## Other Method(s) Used at Last Intercourse with Pill

Domain: Persons who had intercourse with opposite sex during the 3 months prior to interview and used the pill during last intercourse

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    usedlast3m_meth1
  ),
  prefix = 'usedlast3m_meth',
  skip = c(1, 20:21),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    usedlast3m_meth4
  ),
  prefix = 'usedlast3m_meth',
  skip = c(4, 95:96),
  format = 'METH3MF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```


# Method(s) in Past 12 Months

## Size of Domain

Description: Persons who have had intercourse with opposite in the past 12 months

**Females**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(sex12mo),
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(SEX12MO == 'YES, HAD INTERCOURSE'),
  svy(male1719dt)
) |> pretty_estimates() |> kable()
```


## Number of Methods

Domain: Females who have had intercourse with a male in the past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(anyuse12m_meth_count),
  subset(
    svy(fem1719dt),
    sex12mo
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who have had intercourse with a female in the past 12 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(anyuse12m_meth_count),
  subset(
    svy(male1719dt),
    SEX12MO == 'YES, HAD INTERCOURSE'
  )
) |> pretty_estimates() |> kable()
```


## Method(s) Used at Last Intercourse

Domain: Persons who had intercourse with opposite sex during the 12 months prior to interview and used a method of contraception at least once

Description: By method(s), with those using multiple methods counted multiple times

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    anyuse12m_meth_count > 0
  ),
  prefix = 'anyuse12m_meth',
  skip = c(1:2, 22:23, 55, 98:99),
  format = 'METHHXF'
)[order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    anyuse12m_meth_count > 0
  ),
  prefix = 'anyuse12m_meth',
  skip = 98:99,
  format = 'MTHDSV1F'
)[order(-total)] |> pretty_estimates() |> kable()
```


## Method Used Exclusively in Past 12 Months

Domain: Persons who had intercourse with opposite sex during the 12 months prior to interview and reporting using only one method of contraception during the 12 months prior to interview

**Females**

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    anyuse12m_meth_count == 1
  ),
  prefix = 'anyuse12m_meth',
  skip = c(1:2, 22:23, 55, 98:99),
  format = 'METHHXF'
)[total > 0][order(-total)] |> pretty_estimates() |> kable()
```

**Males**

```{r, dependson='process-male-data'}
estimate_mentions(
  sex = 'male',
  svy = subset(
    svy(male1719dt),
    anyuse12m_meth_count == 1
  ),
  prefix = 'anyuse12m_meth',
  skip = 98:99,
  format = 'MTHDSV1F'
)[order(-total)] |> pretty_estimates() |> kable()
```


# Consistency

## Use of Contraception Prior to Nonuse at Last Intercourse

Domain: Females who have had intercourse with a male in the past 3 months and did not use a method of contraception at last intercourse

Description: By whether used a method of contraception in past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~I(anyuse12m_meth_count > 0),
  subset(
    svy(fem1719dt),
    usedlast3m_status == 'Otherwise did not use contraception at last intercourse'
  )
) |> pretty_estimates() |> kable()
```

Domain: Females who have had intercourse with a male in the past 3 months and did not use a method of contraception at last intercourse

Description: By whether used a method of contraception ever

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(EVERUSED),
  subset(
    svy(fem1719dt),
    usedlast3m_status == 'Otherwise did not use contraception at last intercourse'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who have had intercourse with a female in the past 3 months and did not use a method of contraception at last intercourse

Description: By whether used a method of contraception in past 12 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~I(anyuse12m_meth_count > 0),
  subset(
    svy(male1719dt),
    usedlast3m_status == 'Otherwise did not use contraception at last intercourse'
  )
) |> pretty_estimates() |> kable()
```


## Any Method During Past 12 Months

Domain: Females who had intercourse with a male during the 12 months prior to interview, who used a method of contraception at least once, and who do not have active sterilizing operations such as tubal ligations

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(anyuse12m_consistency),
  subset(
    svy(fem1719dt),
    sex12mo &
      anyuse12m_meth_count > 0 &
      TUBS != 'YES'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had used at least one method of contraception during intercourse with wife or cohabitating partner during the 12 months prior to interview, who do not have active sterilizing operations such as vasectomies, and whose partners do not have active sterilizing operations such as tubal ligations

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(anyuse12m_wcp_consistency),
  subset(
    svy(male1719dt),
    !is.na(CWPALLBC01) &
      RSURGSTR != 'YES' &
      PSURGSTR != 'YES'
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had used at least one method of contraception during intercourse with last partner, who is not wife or cohabitating partner, during the 12 months prior to interview, and who do not have active sterilizing operations such as vasectomies

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(anyuse12m_p1_consistency),
  subset(
    svy(male1719dt),
    !is.na(PXMETHOD01) &
      RSURGSTR != 'YES'
  )
) |> pretty_estimates() |> kable()
```


## Condom Use During Past 12 Months

Domain: Females who had intercourse with a male during the 12 months prior to interview, who used condoms at least once in the past 12 months

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(
    P12MOCON,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      'Not Applicable'
    )
  ),
  subset(
    svy(fem1719dt),
    sex12mo &
      anyuse12m_meth4
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had intercourse with a female during the 12 months prior to interview, who used condoms at least once in the past 12 months

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(condom12m_consistency),
  subset(
    svy(male1719dt),
    SEX12MO == 'YES, HAD INTERCOURSE' &
        anyuse12m_meth1
  )
) |> pretty_estimates() |> kable()
```

Domain: Females who had intercourse with a male during the 12 months prior to interview and whose only method of contraception used in the past 12 months is condoms

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(
    P12MOCON,
    levels = c(
      'Every time',
      'Most of the time',
      'About half of the time',
      'Some of the time',
      'None of the time',
      'Refused',
      'Not Applicable'
    )
  ),
  subset(
    svy(fem1719dt),
    sex12mo &
      anyuse12m_meth4 &
      anyuse12m_meth_count == 1
  )
) |> pretty_estimates() |> kable()
```

Domain: Males who had intercourse with a female during the 12 months prior to interview and whose only method of contraception used in the past 12 months is condoms

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(condom12m_consistency),
  subset(
    svy(male1719dt),
    SEX12MO == 'YES, HAD INTERCOURSE' &
      anyuse12m_meth1 &
      anyuse12m_meth_count == 1
  )
) |> pretty_estimates() |> kable()
```


## Pill Use During Past 4 Weeks

Domain: Females who used the pill in the month of the interview or the previous month*

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(MISSPILL),
  subset(
    svy(fem1719dt),
    MISSPILL != 'Not Applicable'
  )
) |> pretty_estimates() |> kable()
```



# Use of Contraceptive Methods for Other Reasons

## Condoms

### Size of Domain

Description: By whether used a condom at last intercourse with a male

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(CONDVAG),
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

Domain: By whether used a condom at last intercourse with a female

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(CONDVAG),
  svy(male1719dt)
) |> pretty_estimates() |> kable()
```

### Reason for Use

Domain: Females who used a condom at last intercourse with a male

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(WHYCONDL),
  subset(
    svy(fem1719dt),
    CONDVAG == 'Yes'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```

Domain: Males who used a condom at last intercourse with a female

```{r, dependson='process-male-data'}
estimate_totals_and_percentages(
  ~factor(WHYCONDL),
  subset(
    svy(male1719dt),
    CONDVAG == 'Yes'
  )
)[order(-total)] |> pretty_estimates() |> kable()
```


## Pill

### Size of Domain

Description: By whether used the pill either during the month of interview or the month preceding the interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~I(thismonth_meth3 | lastmonth_meth3),
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

### Reason(s) for Use

Domain: Females who used the pill either during the month of interview or the month preceding the interview

Description: By reason(s), with those mentioning multiple reasons counted multiple times

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    thismonth_meth3 | lastmonth_meth3
  ),
  prefix = 'whypill_reason',
  format = 'YUSEMTHF',
  skip = 98:99
)[order(-total)] |> pretty_estimates() |> kable()
```

### Contraceptive vs. Noncontraceptive Reasons

Domain: Females who used the pill either during the month of interview or the month preceding the interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~pill_motivation,
  subset(
    svy(fem1719dt),
    thismonth_meth3 | lastmonth_meth3
  )
)[order(-total)] |> pretty_estimates() |> kable()
```


## IUD

### Size of Domain

Description: By whether used an IUD either during the month of interview or the month preceding the interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  #~I(thismonth_meth19 | lastmonth_meth19),
  ~I(!is.na(YUSEIUD1)),
  svy(fem1719dt)
) |> pretty_estimates() |> kable()
```

### Reason(s) for Use

Domain: Females who used an IUD either during the month of interview or the month preceding the interview

Description: By reason(s), with those mentioning multiple reasons counted multiple times

```{r, dependson='process-fem-data'}
estimate_mentions(
  svy = subset(
    svy(fem1719dt),
    #thismonth_meth19 | lastmonth_meth19
    !is.na(YUSEIUD1)
  ),
  prefix = 'whyiud_reason',
  format = 'YUSEMTHF',
  skip = 98:99
)[order(-total)] |> pretty_estimates() |> kable()
```

### Contraceptive vs. Noncontraceptive Reasons

Domain: Females who used an IUD either during the month of interview or the month preceding the interview

```{r, dependson='process-fem-data'}
estimate_totals_and_percentages(
  ~factor(iud_motivation),
  subset(
    svy(fem1719dt),
    #thismonth_meth19 | lastmonth_meth19
    !is.na(YUSEIUD1)
  )
)[order(-total)] |> pretty_estimates() |> kable()
```



* Ever (females)
    * By method(s)
    * By method(s) among those who have had intercourse with opposite sex
    * Ever discontinued due to dissatisfaction
    * Reason for dissatisfaction with pill
    * Reason for dissatisfaction with condoms
    * Reason for dissatisfaction with IUDs



# Things to Do

* Finish collecting estimates into this document
* Organize helper functions into NSFG-specific and more general
* Style plots and tables for output
* Write text of report
* Review situations in which universes do not match specifications in codebooks and follow up with NSFG administrators
* Compare own report with published reports
